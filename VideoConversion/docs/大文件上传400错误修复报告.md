# 大文件上传400错误修复报告

## 📋 问题概述

**错误信息**: `POST http://localhost:5065/api/upload/large-file 400 (Bad Request)`  
**发生时间**: 2025-01-20  
**影响范围**: 大文件上传功能  

## 🚨 错误分析

### 1. **错误现象**
```
POST http://localhost:5065/api/upload/large-file 400 (Bad Request)
❌ 大文件上传失败: Error: 大文件上传失败: HTTP 400
表单提交失败: Error: 大文件上传失败: HTTP 400
```

### 2. **可能原因**
1. **字段名称不匹配** - 前端表单字段与后端期望字段不一致
2. **缺少必需字段** - 后端需要的某些字段在前端表单中缺失
3. **数据格式错误** - 某些字段的数据格式不符合后端要求
4. **文件验证失败** - 文件大小、类型或其他验证条件不满足

## ✅ 已实施的修复

### 1. **修复字段名称不匹配**

#### **音频质量字段**
**修复前**:
```html
<select class="form-select" id="audioBitrate" name="audioBitrate">
```

**修复后**:
```html
<select class="form-select" id="audioQuality" name="audioQuality">
```

**原因**: 后端期望`audioQuality`字段，但前端使用的是`audioBitrate`

### 2. **添加缺失的隐藏字段**

添加了后端期望的所有字段的默认值：

```html
<!-- 隐藏字段 - 提供默认值 -->
<input type="hidden" name="frameRate" value="">
<input type="hidden" name="qualityMode" value="crf">
<input type="hidden" name="audioQualityMode" value="bitrate">
<input type="hidden" name="customParams" value="">
<input type="hidden" name="hardwareAcceleration" value="auto">
<input type="hidden" name="videoFilters" value="">
<input type="hidden" name="audioFilters" value="">
<input type="hidden" name="priority" value="0">
<input type="hidden" name="tags" value="">
<input type="hidden" name="notes" value="">
<input type="hidden" name="encodingPreset" value="medium">
<input type="hidden" name="profile" value="">
<input type="hidden" name="audioChannels" value="">
<input type="hidden" name="sampleRate" value="">
<input type="hidden" name="audioVolume" value="">
<input type="hidden" name="denoise" value="">
<input type="hidden" name="colorSpace" value="">
<input type="hidden" name="pixelFormat" value="">
<input type="hidden" name="twoPass" value="false">
<input type="hidden" name="fastStart" value="true">
<input type="hidden" name="copyTimestamps" value="true">
<input type="hidden" name="deinterlace" value="false">
<input type="hidden" name="startTime" value="">
<input type="hidden" name="endTime" value="">
```

### 3. **增强后端错误日志**

#### **添加详细的表单数据记录**
```csharp
// 记录表单数据用于调试
Logger.LogInformation("收到表单数据: 文件数={FileCount}, 字段数={FieldCount}",
    form.Files.Count, form.Count);

foreach (var key in form.Keys)
{
    Logger.LogDebug("表单字段: {Key} = {Value}", key, form[key]);
}
```

#### **添加转换任务创建日志**
```csharp
Logger.LogInformation("开始从上传文件创建转换任务: 文件={FileName}, 路径={FilePath}", 
    file.FileName, filePath);

var preset = form["preset"].FirstOrDefault() ?? "default";
Logger.LogInformation("使用预设: {Preset}", preset);
```

## 🔧 后端字段映射

### **ConversionTaskRequest字段对照表**

| 后端字段 | 前端字段 | 状态 | 默认值 |
|----------|----------|------|--------|
| `TaskName` | `taskName` | ✅ 可选 | - |
| `Preset` | `preset` | ✅ 必需 | "default" |
| `OutputFormat` | `outputFormat` | ✅ 可选 | - |
| `VideoCodec` | `videoCodec` | ✅ 可选 | - |
| `AudioCodec` | `audioCodec` | ✅ 可选 | - |
| `VideoQuality` | `videoQuality` | ✅ 可选 | - |
| `AudioQuality` | `audioQuality` | ✅ 修复 | - |
| `Resolution` | `resolution` | ✅ 可选 | - |
| `FrameRate` | `frameRate` | ✅ 新增 | "" |
| `QualityMode` | `qualityMode` | ✅ 新增 | "crf" |
| `AudioQualityMode` | `audioQualityMode` | ✅ 新增 | "bitrate" |
| `CustomParameters` | `customParams` | ✅ 新增 | "" |
| `HardwareAcceleration` | `hardwareAcceleration` | ✅ 新增 | "auto" |
| `VideoFilters` | `videoFilters` | ✅ 新增 | "" |
| `AudioFilters` | `audioFilters` | ✅ 新增 | "" |
| `Priority` | `priority` | ✅ 新增 | "0" |
| `Tags` | `tags` | ✅ 新增 | "" |
| `Notes` | `notes` | ✅ 新增 | "" |
| `EncodingPreset` | `encodingPreset` | ✅ 新增 | "medium" |
| `Profile` | `profile` | ✅ 新增 | "" |
| `AudioChannels` | `audioChannels` | ✅ 新增 | "" |
| `SampleRate` | `sampleRate` | ✅ 新增 | "" |
| `AudioVolume` | `audioVolume` | ✅ 新增 | "" |
| `Denoise` | `denoise` | ✅ 新增 | "" |
| `ColorSpace` | `colorSpace` | ✅ 新增 | "" |
| `PixelFormat` | `pixelFormat` | ✅ 新增 | "" |
| `TwoPass` | `twoPass` | ✅ 新增 | "false" |
| `FastStart` | `fastStart` | ✅ 新增 | "true" |
| `CopyTimestamps` | `copyTimestamps` | ✅ 新增 | "true" |
| `Deinterlace` | `deinterlace` | ✅ 新增 | "false" |
| `StartTime` | `startTime` | ✅ 新增 | "" |
| `EndTime` | `endTime` | ✅ 新增 | "" |

## 🧪 调试步骤

### 1. **检查服务器日志**
查看应用程序日志中的详细错误信息：

```bash
# 查看最新的应用日志
tail -f logs/app.log

# 或者在Visual Studio输出窗口查看
```

### 2. **验证表单数据**
在浏览器开发者工具中检查发送的FormData：

```javascript
// 在浏览器控制台中执行
const form = document.getElementById('conversionForm');
const formData = new FormData(form);

// 查看所有表单字段
for (let [key, value] of formData.entries()) {
    console.log(key, value);
}
```

### 3. **测试API端点**
使用Postman或curl测试API：

```bash
curl -X POST http://localhost:5065/api/upload/large-file \
  -F "videoFile=@test.mp4" \
  -F "preset=cpu_standard_1080p" \
  -F "outputFormat=mp4" \
  -F "videoCodec=libx264" \
  -F "audioCodec=aac" \
  -F "videoQuality=23" \
  -F "audioQuality=192k"
```

## 🎯 预期修复效果

### 1. **字段匹配完整性**
- ✅ 所有后端期望的字段都有对应的前端字段
- ✅ 字段名称完全匹配
- ✅ 提供合理的默认值

### 2. **错误信息改善**
- ✅ 详细的服务器日志记录
- ✅ 表单数据完整性验证
- ✅ 更好的错误定位能力

### 3. **用户体验提升**
- ✅ 减少400错误的发生
- ✅ 更快的问题诊断
- ✅ 更稳定的上传功能

## 🔍 进一步排查建议

### 1. **如果问题仍然存在**

#### **检查预设配置**
确保选择的预设在后端存在：
```csharp
// 在ConversionTaskService中检查
var preset = await _presetService.GetPresetAsync(request.Preset);
if (preset == null)
{
    return (false, "", "", $"预设 '{request.Preset}' 不存在");
}
```

#### **验证文件类型**
确保上传的文件类型被支持：
```csharp
var allowedExtensions = new[] { ".mp4", ".avi", ".mov", ".mkv", ".wmv", ".flv", ".webm", ".m4v" };
var fileExtension = Path.GetExtension(file.FileName).ToLowerInvariant();
if (!allowedExtensions.Contains(fileExtension))
{
    return ValidationError($"不支持的文件类型: {fileExtension}");
}
```

#### **检查文件大小限制**
确认文件大小在允许范围内：
```csharp
const long maxFileSize = 32212254720; // 30GB
if (file.Length > maxFileSize)
{
    return ValidationError($"文件大小超过限制: {file.Length} bytes");
}
```

### 2. **监控和日志**

#### **启用详细日志**
在`appsettings.Development.json`中设置：
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "VideoConversion.Controllers": "Debug",
      "VideoConversion.Services": "Debug"
    }
  }
}
```

#### **添加性能监控**
```csharp
using var activity = ActivitySource.StartActivity("UploadLargeFile");
activity?.SetTag("file.name", file.FileName);
activity?.SetTag("file.size", file.Length);
```

## ✅ 修复验证清单

### 前端验证
- [x] 音频质量字段名称已修复
- [x] 所有必需的隐藏字段已添加
- [x] 表单数据完整性确认
- [x] 文件选择验证正常

### 后端验证
- [x] 详细错误日志已添加
- [x] 表单数据记录已实现
- [x] 字段映射检查完成
- [x] 错误处理机制完善

### 功能验证
- [ ] 小文件上传测试
- [ ] 大文件上传测试
- [ ] 不同预设选择测试
- [ ] 错误场景测试

## 🎉 总结

大文件上传400错误的主要修复措施已完成：

1. **字段名称修复**: 将`audioBitrate`改为`audioQuality`
2. **缺失字段补充**: 添加了所有后端期望的隐藏字段
3. **错误日志增强**: 提供了详细的调试信息
4. **调试工具**: 提供了完整的排查步骤

如果问题仍然存在，请查看服务器日志中的详细错误信息，并按照调试步骤进行进一步排查。🚀
