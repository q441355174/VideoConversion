# Index页面功能实现开发步骤文档

## 📋 目录

- [开发环境准备](#开发环境准备)
- [第一阶段：基础架构搭建](#第一阶段基础架构搭建)
- [第二阶段：文件上传模块](#第二阶段文件上传模块)
- [第三阶段：SignalR通信模块](#第三阶段signalr通信模块)
- [第四阶段：转换设置模块](#第四阶段转换设置模块)
- [第五阶段：任务管理模块](#第五阶段任务管理模块)
- [第六阶段：GPU硬件加速模块](#第六阶段gpu硬件加速模块)
- [第七阶段：错误处理和优化](#第七阶段错误处理和优化)
- [第八阶段：测试和部署](#第八阶段测试和部署)

## 🛠️ 开发环境准备

### 前置条件检查
- [ ] .NET 8.0 SDK 已安装
- [ ] Node.js 和 npm 已安装
- [ ] Visual Studio 或 VS Code 已配置
- [ ] Git 版本控制已设置

### 依赖包确认
```xml
<!-- 确认 PackageReference 包含以下依赖 -->
<PackageReference Include="Microsoft.AspNetCore.SignalR" Version="8.0.0" />
<PackageReference Include="Microsoft.AspNetCore.Mvc" Version="8.0.0" />
<PackageReference Include="System.Text.Json" Version="8.0.0" />
```

### 前端资源确认
```html
<!-- 确认以下JavaScript库已引用 -->
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/lib/signalr/dist/browser/signalr.min.js"></script>
```

## 🏗️ 第一阶段：基础架构搭建

### 步骤1.1：创建页面基础结构

#### 任务清单
- [ ] 创建响应式布局容器
- [ ] 设置页面标题和导航
- [ ] 添加基础CSS样式
- [ ] 创建主要区域划分

#### 实现代码
```html
<!-- 页面头部 -->
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-video text-primary"></i>
                视频转换工具
            </h1>
        </div>
    </div>
    
    <!-- 主要内容区域 -->
    <div class="row">
        <!-- 左侧：文件上传和设置 -->
        <div class="col-lg-8">
            <div id="fileUploadSection">
                <!-- 文件上传区域 - 待实现 -->
            </div>
            <div id="conversionSettings">
                <!-- 转换设置区域 - 待实现 -->
            </div>
        </div>
        
        <!-- 右侧：状态和信息 -->
        <div class="col-lg-4">
            <div id="currentTaskSection">
                <!-- 当前任务显示 - 待实现 -->
            </div>
            <div id="gpuInfoSection">
                <!-- GPU信息显示 - 待实现 -->
            </div>
            <div id="recentTasksSection">
                <!-- 最近任务列表 - 待实现 -->
            </div>
        </div>
    </div>
</div>
```

### 步骤1.2：初始化JavaScript架构

#### 任务清单
- [ ] 创建全局变量和配置
- [ ] 设置页面初始化函数
- [ ] 添加基础工具函数
- [ ] 建立错误处理框架

#### 实现代码
```javascript
<script>
// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 Index页面初始化开始...');
    
    // 全局变量初始化
    initializeGlobalVariables();
    
    // 基础工具函数设置
    setupUtilityFunctions();
    
    // 页面组件初始化
    initializePageComponents();
    
    console.log('✅ Index页面初始化完成');
});

// 全局变量
let currentTaskId = null;
let connectionState = 'Disconnected';
let currentTaskStartTime = null;
let lastProgressUpdate = null;
let connection = null;

// 全局变量初始化
function initializeGlobalVariables() {
    console.log('🔧 初始化全局变量...');
    
    // SignalR连接配置
    connection = new signalR.HubConnectionBuilder()
        .withUrl("/conversionHub")
        .withAutomaticReconnect([0, 2000, 10000, 30000])
        .configureLogging(signalR.LogLevel.Information)
        .build();
}

// 基础工具函数
function setupUtilityFunctions() {
    console.log('🛠️ 设置基础工具函数...');
    // 工具函数将在后续步骤中实现
}

// 页面组件初始化
function initializePageComponents() {
    console.log('🎨 初始化页面组件...');
    // 各个模块的初始化将在后续步骤中实现
}
</script>
```

### 步骤1.3：添加基础工具函数

#### 任务清单
- [ ] 实现消息提示函数
- [ ] 添加文件大小格式化函数
- [ ] 创建时间格式化函数
- [ ] 实现连接状态更新函数

#### 实现代码
```javascript
// 基础工具函数实现
function setupUtilityFunctions() {
    console.log('🛠️ 设置基础工具函数...');
    
    // 消息提示函数
    window.showAlert = function(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                type === 'danger' ? 'exclamation-triangle' : 
                                'info-circle'}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // 5秒后自动消失
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    };
    
    // 文件大小格式化
    window.formatFileSize = function(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${(bytes / Math.pow(k, i)).toFixed(i === 0 ? 0 : 1)} ${sizes[i]}`;
    };
    
    // 时间格式化
    window.formatTime = function(seconds) {
        if (!seconds || seconds <= 0) return '-';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        if (hours > 0) {
            return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        } else {
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    };
    
    // 连接状态更新
    window.updateConnectionStatus = function(status) {
        connectionState = status;
        const statusElement = document.getElementById('connectionStatus');
        if (statusElement) {
            statusElement.textContent = status;
            statusElement.className = `badge ${status === 'Connected' ? 'bg-success' : 
                                               status === 'Reconnecting' ? 'bg-warning' : 'bg-danger'}`;
        }
    };
}
```

## 📁 第二阶段：文件上传模块

### 步骤2.1：创建文件上传界面

#### 任务清单
- [ ] 设计拖拽上传区域
- [ ] 添加文件选择按钮
- [ ] 创建文件信息显示区域
- [ ] 添加上传进度显示

#### 实现代码
```html
<!-- 文件上传区域 -->
<div id="fileUploadSection" class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-upload text-primary"></i>
            文件上传
        </h5>
    </div>
    <div class="card-body">
        <!-- 拖拽上传区域 -->
        <div class="file-drop-zone border-dashed p-4 text-center" id="fileDropZone">
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <p class="mb-2">拖拽视频文件到此处或点击选择文件</p>
            <input type="file" class="form-control" id="videoFile" name="videoFile" 
                   accept=".mp4,.avi,.mov,.mkv,.wmv,.flv,.webm,.m4v" required>
            <small class="text-muted">
                支持格式: MP4, AVI, MOV, MKV, WMV, FLV, WebM, M4V (最大2GB)
            </small>
        </div>
        
        <!-- 文件信息显示 -->
        <div id="selectedFileInfo" style="display: none;" class="mt-3">
            <div class="alert alert-info">
                <h6><i class="fas fa-file-video"></i> 已选择文件</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>文件名:</strong> <span id="selectedFileName"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>大小:</strong> <span id="selectedFileSize"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 上传进度显示 -->
        <div id="uploadProgressContainer" style="display: none;" class="mt-3">
            <div class="card border-primary">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-upload text-primary"></i>
                        文件上传进度
                    </h6>
                </div>
                <div class="card-body">
                    <div class="progress mb-2" style="height: 20px;">
                        <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="row text-muted small">
                        <div class="col-4">
                            <i class="fas fa-percentage"></i>
                            <span id="uploadPercentage">0%</span>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-tachometer-alt"></i>
                            <span id="uploadSpeed">0 MB/s</span>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-clock"></i>
                            <span id="uploadTimeRemaining">计算中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

### 步骤2.2：实现文件选择和验证

#### 任务清单
- [ ] 绑定文件选择事件
- [ ] 实现文件格式验证
- [ ] 添加文件大小检查
- [ ] 显示文件信息

#### 实现代码
```javascript
// 文件上传模块初始化
function initializeFileUpload() {
    console.log('📁 初始化文件上传模块...');
    
    const fileInput = document.getElementById('videoFile');
    const dropZone = document.getElementById('fileDropZone');
    
    // 绑定文件选择事件
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });
    }
    
    // 初始化拖拽功能
    if (dropZone) {
        initializeFileDragDrop();
    }
}

// 文件选择处理
function handleFileSelection(file) {
    console.log('📄 处理文件选择:', file.name);
    
    // 文件验证
    if (!validateFile(file)) {
        return;
    }
    
    // 显示文件信息
    displayFileInfo(file);
    
    // 触发智能预设选择
    initializeSmartPresetSelection();
}

// 文件验证
function validateFile(file) {
    console.log('🔍 验证文件:', file.name);
    
    // 检查文件类型
    const allowedExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm', '.m4v'];
    const fileName = file.name.toLowerCase();
    const isValidType = allowedExtensions.some(ext => fileName.endsWith(ext));
    
    if (!isValidType) {
        showAlert('danger', `不支持的文件格式。支持的格式: ${allowedExtensions.join(', ')}`);
        return false;
    }
    
    // 检查文件大小 (2GB限制)
    const maxSize = 2 * 1024 * 1024 * 1024; // 2GB
    if (file.size > maxSize) {
        showAlert('danger', `文件大小超过限制: ${formatFileSize(file.size)} > ${formatFileSize(maxSize)}`);
        return false;
    }
    
    // 检查最小文件大小
    if (file.size < 1024) {
        showAlert('danger', '文件太小，可能不是有效的视频文件');
        return false;
    }
    
    console.log('✅ 文件验证通过');
    return true;
}

// 显示文件信息
function displayFileInfo(file) {
    console.log('📋 显示文件信息');
    
    const fileInfoDiv = document.getElementById('selectedFileInfo');
    const fileName = document.getElementById('selectedFileName');
    const fileSize = document.getElementById('selectedFileSize');
    
    if (fileName) fileName.textContent = file.name;
    if (fileSize) fileSize.textContent = formatFileSize(file.size);
    if (fileInfoDiv) fileInfoDiv.style.display = 'block';
}
```

### 步骤2.3：实现拖拽上传功能

#### 任务清单
- [ ] 绑定拖拽事件监听器
- [ ] 实现拖拽视觉反馈
- [ ] 处理文件拖拽释放
- [ ] 防止默认浏览器行为

#### 实现代码
```javascript
// 拖拽功能初始化
function initializeFileDragDrop() {
    console.log('🎯 初始化拖拽上传功能...');

    const dropZone = document.getElementById('fileDropZone');

    // 防止默认拖拽行为
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // 拖拽进入/离开视觉反馈
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    // 文件拖拽处理
    dropZone.addEventListener('drop', handleDrop, false);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight(e) {
    e.currentTarget.classList.add('dragover');
}

function unhighlight(e) {
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;

    if (files.length > 0) {
        const fileInput = document.getElementById('videoFile');
        fileInput.files = files;
        handleFileSelection(files[0]);
    }
}
```

### 步骤2.4：实现大文件上传处理

#### 任务清单
- [ ] 检测文件大小阈值
- [ ] 实现大文件上传API调用
- [ ] 添加上传进度跟踪
- [ ] 处理上传错误

#### 实现代码
```javascript
// 大文件上传处理
async function handleLargeFileUpload(file, formData) {
    console.log('📤 处理大文件上传:', file.name);

    const isLargeFile = file.size > 100 * 1024 * 1024; // 100MB阈值

    if (isLargeFile) {
        console.log('🔄 使用大文件上传API');

        // 显示上传进度
        showUploadProgress();

        try {
            const response = await fetch('/api/upload/large-file', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                console.log('✅ 大文件上传成功');
                hideUploadProgress();
                return result;
            } else {
                throw new Error(result.message || '上传失败');
            }
        } catch (error) {
            console.error('❌ 大文件上传失败:', error);
            hideUploadProgress();
            throw error;
        }
    } else {
        console.log('📤 使用标准上传方式');
        return await handleNormalUpload(formData);
    }
}

// 显示上传进度
function showUploadProgress() {
    const container = document.getElementById('uploadProgressContainer');
    if (container) {
        container.style.display = 'block';
    }
}

// 隐藏上传进度
function hideUploadProgress() {
    const container = document.getElementById('uploadProgressContainer');
    if (container) {
        container.style.display = 'none';
    }
}

// 更新上传进度
function updateUploadProgress(data) {
    const progressBar = document.getElementById('uploadProgressBar');
    const percentage = document.getElementById('uploadPercentage');
    const speed = document.getElementById('uploadSpeed');
    const timeRemaining = document.getElementById('uploadTimeRemaining');

    if (progressBar && data.Progress) {
        progressBar.style.width = `${data.Progress}%`;
        progressBar.setAttribute('aria-valuenow', data.Progress);
    }

    if (percentage && data.Progress) {
        percentage.textContent = `${data.Progress}%`;
    }

    if (speed && data.Speed) {
        speed.textContent = formatFileSize(data.Speed) + '/s';
    }

    if (timeRemaining && data.EstimatedTimeRemaining) {
        timeRemaining.textContent = formatTime(data.EstimatedTimeRemaining);
    }
}
```

## 📡 第三阶段：SignalR通信模块

### 步骤3.1：建立SignalR连接

#### 任务清单
- [ ] 配置SignalR连接参数
- [ ] 实现连接启动函数
- [ ] 添加连接状态监控
- [ ] 处理连接错误

#### 实现代码
```javascript
// SignalR连接初始化
function initializeSignalR() {
    console.log('📡 初始化SignalR连接...');

    // 设置连接状态事件
    setupConnectionEvents();

    // 启动连接
    startConnection();

    // 注册事件监听器
    registerSignalREvents();
}

// 启动SignalR连接
async function startConnection() {
    try {
        console.log('🔌 启动SignalR连接...');
        await connection.start();
        console.log("✅ SignalR连接成功");
        updateConnectionStatus('Connected');
        showAlert('success', 'SignalR连接已建立，可以实时接收转换进度');

        // 连接成功后加载最近任务
        loadRecentTasks();
    } catch (err) {
        console.error("❌ SignalR连接失败:", err);
        updateConnectionStatus('Failed');
        showAlert('danger', 'SignalR连接失败，进度更新可能不可用');

        // 5秒后重试连接
        setTimeout(startConnection, 5000);
    }
}

// 连接状态事件处理
function setupConnectionEvents() {
    // 重连中事件
    connection.onreconnecting((error) => {
        console.log("🔄 SignalR重连中...", error);
        updateConnectionStatus('Reconnecting');
        showAlert('warning', 'SignalR连接中断，正在重连...');
    });

    // 重连成功事件
    connection.onreconnected((connectionId) => {
        console.log("✅ SignalR重连成功:", connectionId);
        updateConnectionStatus('Connected');
        showAlert('success', 'SignalR连接已恢复');

        // 重连后重新加入任务组
        if (currentTaskId) {
            connection.invoke("JoinTaskGroup", currentTaskId).catch(err => {
                console.error("重新加入任务组失败:", err);
            });
        }

        // 刷新任务状态
        loadRecentTasks();
    });

    // 连接关闭事件
    connection.onclose((error) => {
        console.warn("⚠️ SignalR连接已关闭:", error);
        updateConnectionStatus('Disconnected');
        showAlert('warning', 'SignalR连接已断开');
    });
}
```

### 步骤3.2：注册SignalR事件监听器

#### 任务清单
- [ ] 注册进度更新事件
- [ ] 注册任务状态事件
- [ ] 注册上传进度事件
- [ ] 注册错误处理事件

#### 实现代码
```javascript
// 注册SignalR事件监听器
function registerSignalREvents() {
    console.log('📋 注册SignalR事件监听器...');

    // 监听进度更新
    connection.on("ProgressUpdate", function (data) {
        console.log("📊 收到进度更新:", data);
        updateProgress(data);
    });

    // 监听任务开始
    connection.on("TaskStarted", function (data) {
        console.log("🚀 任务开始:", data);
        handleTaskStarted(data);
    });

    // 监听任务完成
    connection.on("TaskCompleted", function (data) {
        console.log("✅ 任务完成:", data);
        handleTaskCompleted(data);
    });

    // 监听任务失败
    connection.on("TaskFailed", function (data) {
        console.log("❌ 任务失败:", data);
        handleTaskFailed(data);
    });

    // 监听上传进度
    connection.on("UploadProgress", function (data) {
        console.log("📤 上传进度:", data);
        updateUploadProgress(data);
    });

    // 监听上传完成
    connection.on("UploadCompleted", function (data) {
        console.log("✅ 上传完成:", data);
        showAlert('success', `文件上传完成: ${data.FilePath}`);
        hideUploadProgress();
    });

    // 监听上传失败
    connection.on("UploadFailed", function (data) {
        console.log("❌ 上传失败:", data);
        showAlert('danger', `上传失败: ${data.ErrorMessage}`);
        hideUploadProgress();
    });

    // 监听系统通知
    connection.on("SystemNotification", function (data) {
        console.log("📢 系统通知:", data);
        showAlert(data.type || 'info', data.message);
    });

    // 监听错误
    connection.on("Error", function (message) {
        console.error("❌ SignalR错误:", message);
        showAlert('danger', 'SignalR错误: ' + message);
    });
}
```

## ⚙️ 第四阶段：转换设置模块

### 步骤4.1：创建智能预设选择功能

#### 任务清单
- [ ] 实现GPU能力检测
- [ ] 创建预设优先级映射
- [ ] 实现自动预设选择
- [ ] 添加预设选择通知

#### 实现代码
```javascript
// 智能预设选择初始化
async function initializeSmartPresetSelection() {
    try {
        console.log('🔍 开始智能GPU预设选择...');

        // 1. 检查GPU能力
        const gpuResponse = await fetch('/api/gpu/capabilities');
        const gpuData = await gpuResponse.json();

        if (gpuData.success && gpuData.data) {
            const capabilities = gpuData.data;
            console.log('GPU能力检测结果:', capabilities);

            // 2. 根据GPU类型选择预设
            if (capabilities.nvidia && capabilities.nvidia.supported) {
                selectBestGpuPreset('nvenc');
                console.log('✅ 自动选择NVIDIA GPU预设');
            } else if (capabilities.intel && capabilities.intel.supported) {
                selectBestGpuPreset('qsv');
                console.log('✅ 自动选择Intel GPU预设');
            } else if (capabilities.amd && capabilities.amd.supported) {
                selectBestGpuPreset('amf');
                console.log('✅ 自动选择AMD GPU预设');
            } else {
                console.log('ℹ️ 未检测到GPU支持，使用默认CPU预设');
                selectDefaultCpuPreset();
            }
        } else {
            console.log('⚠️ GPU检测失败，使用默认预设');
            selectDefaultCpuPreset();
        }
    } catch (error) {
        console.error('❌ 智能预设选择失败:', error);
        selectDefaultCpuPreset();
    }
}

// 选择最佳GPU预设
function selectBestGpuPreset(gpuType) {
    const presetSelect = document.getElementById('preset');
    if (!presetSelect) return;

    // 预设优先级映射
    const presetPriority = {
        'nvenc': [
            'GPU Fast 1080p (NVENC)',
            'GPU High Quality 1080p (NVENC)',
            'GPU 4K Ultra (NVENC)'
        ],
        'qsv': [
            'GPU Fast 1080p (QSV)',
            'GPU High Quality 1080p (QSV)'
        ],
        'amf': [
            'GPU Fast 1080p (AMF)',
            'GPU High Quality 1080p (AMF)'
        ]
    };

    const preferredPresets = presetPriority[gpuType] || [];

    // 按优先级查找并选择预设
    for (const presetName of preferredPresets) {
        for (let i = 0; i < presetSelect.options.length; i++) {
            if (presetSelect.options[i].text.includes(presetName) ||
                presetSelect.options[i].value === presetName) {
                presetSelect.selectedIndex = i;
                updateAdvancedSettings(presetName);

                // 显示GPU加速提示
                showGpuAccelNotification(presetName, gpuType);
                return;
            }
        }
    }
}

// 选择默认CPU预设
function selectDefaultCpuPreset() {
    const presetSelect = document.getElementById('preset');
    if (!presetSelect) return;

    // 查找CPU预设
    for (let i = 0; i < presetSelect.options.length; i++) {
        const optionText = presetSelect.options[i].text.toLowerCase();
        if (optionText.includes('cpu') || optionText.includes('standard')) {
            presetSelect.selectedIndex = i;
            updateAdvancedSettings(presetSelect.options[i].value);
            break;
        }
    }
}

// 显示GPU加速通知
function showGpuAccelNotification(presetName, gpuType) {
    const gpuTypeMap = {
        'nvenc': 'NVIDIA',
        'qsv': 'Intel',
        'amf': 'AMD'
    };

    const gpuName = gpuTypeMap[gpuType] || gpuType;
    showAlert('info', `🚀 已启用${gpuName} GPU硬件加速，转换速度将显著提升！`);
}

// 更新高级设置
function updateAdvancedSettings(presetName) {
    console.log('⚙️ 更新高级设置:', presetName);

    // 根据预设名称更新各种设置
    const presetConfig = getPresetConfiguration(presetName);

    if (presetConfig) {
        // 更新输出格式
        if (presetConfig.outputFormat) {
            const outputFormat = document.getElementById('outputFormat');
            if (outputFormat) outputFormat.value = presetConfig.outputFormat;
        }

        // 更新视频编解码器
        if (presetConfig.videoCodec) {
            const videoCodec = document.getElementById('videoCodec');
            if (videoCodec) videoCodec.value = presetConfig.videoCodec;
        }

        // 更新质量设置
        if (presetConfig.quality) {
            const videoQuality = document.getElementById('videoQuality');
            const qualityValue = document.getElementById('qualityValue');
            if (videoQuality) videoQuality.value = presetConfig.quality;
            if (qualityValue) qualityValue.textContent = presetConfig.quality;
        }

        // 更新分辨率
        if (presetConfig.resolution) {
            const resolution = document.getElementById('resolution');
            if (resolution) resolution.value = presetConfig.resolution;
        }
    }
}

// 获取预设配置
function getPresetConfiguration(presetName) {
    const presetConfigs = {
        'GPU Fast 1080p (NVENC)': {
            outputFormat: 'mp4',
            videoCodec: 'h264_nvenc',
            resolution: '1920x1080',
            quality: 23
        },
        'GPU High Quality 1080p (NVENC)': {
            outputFormat: 'mp4',
            videoCodec: 'h264_nvenc',
            resolution: '1920x1080',
            quality: 18
        },
        'GPU Fast 1080p (QSV)': {
            outputFormat: 'mp4',
            videoCodec: 'h264_qsv',
            resolution: '1920x1080',
            quality: 23
        },
        'GPU Fast 1080p (AMF)': {
            outputFormat: 'mp4',
            videoCodec: 'h264_amf',
            resolution: '1920x1080',
            quality: 23
        }
        // 可以添加更多预设配置...
    };

    return presetConfigs[presetName] || null;
}
```

### 步骤4.2：实现表单提交处理

#### 任务清单
- [ ] 绑定表单提交事件
- [ ] 实现表单数据验证
- [ ] 处理大文件上传逻辑
- [ ] 添加提交状态管理

#### 实现代码
```javascript
// 表单提交处理初始化
function initializeFormSubmission() {
    console.log('📝 初始化表单提交处理...');

    const form = document.getElementById('conversionForm');
    if (form) {
        form.addEventListener('submit', handleFormSubmit);
    }

    // 绑定质量滑块事件
    const qualitySlider = document.getElementById('videoQuality');
    const qualityValue = document.getElementById('qualityValue');
    if (qualitySlider && qualityValue) {
        qualitySlider.addEventListener('input', function() {
            qualityValue.textContent = this.value;
        });
    }
}

// 表单提交处理
async function handleFormSubmit(e) {
    e.preventDefault();

    console.log('📤 处理表单提交...');

    const fileInput = document.getElementById('videoFile');
    const file = fileInput.files[0];

    if (!file) {
        showAlert('warning', '请选择要转换的视频文件');
        return;
    }

    // 创建FormData
    const formData = new FormData(e.target);

    // 处理复选框值
    const checkboxes = ['twoPass', 'fastStart', 'copyTimestamps'];
    checkboxes.forEach(name => {
        const checkbox = document.getElementById(name);
        if (checkbox) {
            formData.delete(name);
            formData.append(name, checkbox.checked ? 'true' : 'false');
        }
    });

    try {
        // 更新提交按钮状态
        updateSubmitButtonState('submitting');

        // 检查文件大小，决定使用哪种上传方式
        const isLargeFile = file.size > 100 * 1024 * 1024; // 100MB

        let result;
        if (isLargeFile) {
            result = await handleLargeFileUpload(file, formData);
        } else {
            result = await handleNormalFileUpload(formData);
        }

        if (result.success) {
            showAlert('success', '转换任务已提交');
            // 任务开始事件会通过SignalR接收
        } else {
            throw new Error(result.message || '提交失败');
        }
    } catch (error) {
        console.error('表单提交失败:', error);
        showAlert('danger', '提交失败: ' + error.message);
    } finally {
        // 恢复提交按钮状态
        updateSubmitButtonState('normal');
    }
}

// 普通文件上传
async function handleNormalFileUpload(formData) {
    console.log('📤 处理普通文件上传...');

    const response = await fetch('/api/conversion/start', {
        method: 'POST',
        body: formData
    });

    return await response.json();
}

// 更新提交按钮状态
function updateSubmitButtonState(state) {
    const button = document.getElementById('startConversion');
    if (!button) return;

    switch (state) {
        case 'submitting':
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
            break;
        case 'normal':
        default:
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-play"></i> 开始转换';
            break;
    }
}
```

## 📊 第五阶段：任务管理模块

### 步骤5.1：创建任务显示界面

#### 任务清单
- [ ] 设计当前任务显示区域
- [ ] 创建进度条和状态显示
- [ ] 添加任务操作按钮
- [ ] 实现最近任务列表

#### 实现代码
```html
<!-- 当前任务显示区域 -->
<div id="currentTaskSection" class="card mb-4" style="display: none;">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
            <i class="fas fa-cog fa-spin"></i>
            当前转换任务
        </h6>
    </div>
    <div class="card-body">
        <!-- 任务基本信息 -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
                <span id="currentTaskName">任务名称</span>
            </h6>
            <small class="text-muted" id="taskId">任务ID</small>
        </div>

        <!-- 文件信息 -->
        <div class="row mb-3" id="fileInfo" style="display: none;">
            <div class="col-6">
                <small class="text-muted">原始文件</small><br>
                <span id="originalFileName" class="fw-bold"></span>
            </div>
            <div class="col-6">
                <small class="text-muted">输出格式</small><br>
                <span id="outputFormat" class="fw-bold"></span>
            </div>
        </div>

        <!-- 进度条 -->
        <div class="progress mb-3" style="height: 25px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <span class="fw-bold">0%</span>
            </div>
        </div>

        <!-- 详细状态信息 -->
        <div class="row text-center mb-3">
            <div class="col-3">
                <small class="text-muted">转换速度</small><br>
                <span id="conversionSpeed" class="fw-bold">-</span>
            </div>
            <div class="col-3">
                <small class="text-muted">剩余时间</small><br>
                <span id="remainingTime" class="fw-bold">-</span>
            </div>
            <div class="col-3">
                <small class="text-muted">已用时间</small><br>
                <span id="elapsedTime" class="fw-bold">-</span>
            </div>
            <div class="col-3">
                <small class="text-muted">文件大小</small><br>
                <span id="fileSize" class="fw-bold">-</span>
            </div>
        </div>

        <!-- 当前状态 -->
        <div class="alert alert-info mb-3" role="alert" id="taskStatusAlert">
            <i class="fas fa-info-circle"></i>
            <span id="taskStatus">等待中...</span>
        </div>

        <!-- 操作按钮 -->
        <div class="d-flex gap-2" id="taskActionButtons">
            <button type="button" class="btn btn-outline-danger btn-sm" id="cancelTask">
                <i class="fas fa-stop"></i> 取消转换
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" id="refreshTask" style="display: none;">
                <i class="fas fa-sync"></i> 刷新状态
            </button>
            <a class="btn btn-outline-success btn-sm" id="downloadTask" style="display: none;">
                <i class="fas fa-download"></i> 下载文件
            </a>
            <button type="button" class="btn btn-outline-primary btn-sm" id="restartTask" style="display: none;">
                <i class="fas fa-redo"></i> 重新开始
            </button>
        </div>
    </div>
</div>

<!-- 最近任务列表 -->
<div id="recentTasksSection" class="card">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-history text-secondary"></i>
            最近任务
        </h6>
    </div>
    <div class="card-body">
        <div id="recentTasks">
            <p class="text-muted text-center">暂无最近任务</p>
        </div>
    </div>
</div>
```

### 步骤5.2：实现任务状态管理

#### 任务清单
- [ ] 实现任务开始处理
- [ ] 添加进度更新逻辑
- [ ] 处理任务完成和失败
- [ ] 实现任务操作功能

#### 实现代码
```javascript
// 任务管理模块初始化
function initializeTaskManagement() {
    console.log('📊 初始化任务管理模块...');

    // 绑定任务操作按钮事件
    bindTaskActionButtons();

    // 加载最近任务
    loadRecentTasks();
}

// 任务开始处理
function handleTaskStarted(data) {
    console.log('🚀 任务开始:', data);

    currentTaskId = data.taskId;
    currentTaskStartTime = new Date();

    // 显示当前任务
    showCurrentTask(data);

    // 加入任务组以接收进度更新
    connection.invoke("JoinTaskGroup", data.taskId).catch(err => {
        console.error("加入任务组失败:", err);
    });

    // 开始计时
    startTaskTimer();

    // 更新UI状态
    updateTaskActionButtons('running');

    // 显示通知
    showAlert('info', `转换任务已开始: ${data.fileName || data.taskId}`);
}

// 显示当前任务
function showCurrentTask(data) {
    console.log('📋 显示当前任务');

    const currentTaskSection = document.getElementById('currentTaskSection');
    const taskName = document.getElementById('currentTaskName');
    const taskIdElement = document.getElementById('taskId');
    const originalFileName = document.getElementById('originalFileName');
    const fileInfo = document.getElementById('fileInfo');

    // 更新任务信息
    if (taskName) taskName.textContent = data.fileName || data.taskId;
    if (taskIdElement) taskIdElement.textContent = data.taskId;

    // 显示文件信息
    if (data.fileName && originalFileName) {
        originalFileName.textContent = data.fileName;
        if (fileInfo) fileInfo.style.display = 'block';
    }

    // 重置进度条
    resetProgressBar();

    // 显示任务容器
    if (currentTaskSection) {
        currentTaskSection.style.display = 'block';
    }
}

// 重置进度条
function resetProgressBar() {
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
        const span = progressBar.querySelector('span');
        if (span) span.textContent = '0%';
    }
}

// 进度更新处理
function updateProgress(data) {
    if (!data || !data.taskId || data.taskId !== currentTaskId) return;

    console.log('📊 更新进度:', data.progress + '%');

    // 更新进度条
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = `${data.progress}%`;
        progressBar.setAttribute('aria-valuenow', data.progress);
        const span = progressBar.querySelector('span');
        if (span) span.textContent = `${data.progress}%`;
    }

    // 更新详细信息
    updateTaskDetails(data);

    // 更新最近任务列表中的进度
    updateRecentTaskProgress(data.taskId, data.progress);
}

// 更新任务详细信息
function updateTaskDetails(data) {
    // 更新转换速度
    if (data.speed) {
        const speedElement = document.getElementById('conversionSpeed');
        if (speedElement) speedElement.textContent = data.speed;
    }

    // 更新剩余时间
    if (data.remainingSeconds) {
        const remainingElement = document.getElementById('remainingTime');
        if (remainingElement) {
            remainingElement.textContent = formatTime(data.remainingSeconds);
        }
    }

    // 更新已用时间
    if (currentTaskStartTime) {
        const elapsedSeconds = Math.floor((new Date() - currentTaskStartTime) / 1000);
        const elapsedElement = document.getElementById('elapsedTime');
        if (elapsedElement) {
            elapsedElement.textContent = formatTime(elapsedSeconds);
        }
    }

    // 更新状态消息
    if (data.message) {
        const statusElement = document.getElementById('taskStatus');
        if (statusElement) statusElement.textContent = data.message;
    }
}

// 任务完成处理
function handleTaskCompleted(data) {
    console.log('✅ 任务完成:', data);

    currentTaskId = null;
    currentTaskStartTime = null;

    // 更新进度条为100%
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.setAttribute('aria-valuenow', '100');
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        const span = progressBar.querySelector('span');
        if (span) span.textContent = '100%';
    }

    // 更新状态
    updateTaskStatus('转换完成！', 'success');

    // 显示下载按钮
    if (data.downloadUrl) {
        showDownloadButton(data.downloadUrl, data.fileName);
    }

    // 更新操作按钮
    updateTaskActionButtons('completed');

    // 刷新最近任务列表
    loadRecentTasks();

    // 显示成功消息
    const duration = data.duration ? ` (耗时: ${formatTime(data.duration)})` : '';
    showAlert('success', `转换完成: ${data.fileName || data.taskId}${duration}`);
}

// 任务失败处理
function handleTaskFailed(data) {
    console.log('❌ 任务失败:', data);

    currentTaskId = null;
    currentTaskStartTime = null;

    // 更新进度条样式
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-danger');
    }

    // 更新状态
    updateTaskStatus(`转换失败: ${data.error || '未知错误'}`, 'danger');

    // 更新操作按钮
    updateTaskActionButtons('failed');

    // 刷新最近任务列表
    loadRecentTasks();

    // 显示错误消息
    showAlert('danger', `转换失败: ${data.fileName || data.taskId} - ${data.error || '未知错误'}`);
}

// 更新任务状态显示
function updateTaskStatus(message, type) {
    const statusAlert = document.getElementById('taskStatusAlert');
    const statusElement = document.getElementById('taskStatus');

    if (statusElement) statusElement.textContent = message;
    if (statusAlert) {
        statusAlert.className = `alert alert-${type} mb-3`;
    }
}

// 显示下载按钮
function showDownloadButton(downloadUrl, fileName) {
    const downloadBtn = document.getElementById('downloadTask');
    if (downloadBtn) {
        downloadBtn.href = downloadUrl;
        downloadBtn.download = fileName || 'converted_video';
        downloadBtn.style.display = 'inline-block';
    }
}

// 更新任务操作按钮状态
function updateTaskActionButtons(status) {
    const cancelBtn = document.getElementById('cancelTask');
    const refreshBtn = document.getElementById('refreshTask');
    const downloadBtn = document.getElementById('downloadTask');
    const restartBtn = document.getElementById('restartTask');

    // 隐藏所有按钮
    [cancelBtn, refreshBtn, downloadBtn, restartBtn].forEach(btn => {
        if (btn) btn.style.display = 'none';
    });

    // 根据状态显示相应按钮
    switch (status) {
        case 'running':
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
            if (refreshBtn) refreshBtn.style.display = 'inline-block';
            break;
        case 'completed':
            if (downloadBtn) downloadBtn.style.display = 'inline-block';
            if (restartBtn) restartBtn.style.display = 'inline-block';
            break;
        case 'failed':
            if (refreshBtn) refreshBtn.style.display = 'inline-block';
            if (restartBtn) restartBtn.style.display = 'inline-block';
            break;
    }
}
```

## 🖥️ 第六阶段：GPU硬件加速模块

### 步骤6.1：创建GPU信息显示界面

#### 任务清单
- [ ] 设计GPU信息卡片
- [ ] 添加GPU状态指示器
- [ ] 创建刷新按钮
- [ ] 实现加载状态显示

#### 实现代码
```html
<!-- GPU信息显示区域 -->
<div id="gpuInfoSection" class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-microchip text-primary"></i>
                GPU硬件加速
            </h6>
            <button class="btn btn-outline-primary btn-sm" onclick="loadGpuInfo()">
                <i class="fas fa-redo"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="gpuInfo">
            <!-- GPU信息将通过JavaScript动态加载 -->
        </div>
    </div>
</div>
```

### 步骤6.2：实现GPU检测逻辑

#### 任务清单
- [ ] 实现GPU信息加载函数
- [ ] 添加GPU信息显示逻辑
- [ ] 处理GPU检测错误
- [ ] 创建GPU卡片生成器

#### 实现代码
```javascript
// GPU模块初始化
function initializeGpuModule() {
    console.log('🖥️ 初始化GPU模块...');

    // 加载GPU信息
    loadGpuInfo();
}

// GPU信息加载
async function loadGpuInfo() {
    const gpuInfoDiv = document.getElementById('gpuInfo');
    if (!gpuInfoDiv) return;

    try {
        console.log('🔍 检测GPU硬件加速能力...');

        // 显示加载状态
        gpuInfoDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">检测中...</span>
                </div>
                <p class="mt-2 mb-0 text-muted">正在检测GPU硬件加速能力...</p>
            </div>
        `;

        const response = await fetch('/api/gpu/capabilities');
        const result = await response.json();

        if (result.success) {
            displayGpuInfo(result.data);
        } else {
            displayGpuError('获取GPU信息失败: ' + (result.message || '未知错误'));
        }
    } catch (error) {
        console.error('GPU信息加载失败:', error);
        displayGpuError('无法连接到GPU检测服务');
    }
}

// 显示GPU信息
function displayGpuInfo(gpuData) {
    const gpuInfoDiv = document.getElementById('gpuInfo');
    if (!gpuInfoDiv) return;

    console.log('📊 显示GPU信息:', gpuData);

    if (!gpuData.hasAnyGpuSupport) {
        // 无GPU支持的情况
        gpuInfoDiv.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                <h6>未检测到GPU硬件加速支持</h6>
                <p class="mb-2">系统将使用CPU进行视频转码</p>
                <small class="text-muted">
                    检测时间: ${new Date().toLocaleString()}
                </small>
            </div>
        `;
        return;
    }

    // 有GPU支持的情况
    let html = `
        <div class="alert alert-success mb-3">
            <strong><i class="fas fa-check-circle"></i> GPU硬件加速可用!</strong><br>
            <small>支持的GPU类型: ${getSupportedGpuTypes(gpuData)}</small>
        </div>
    `;

    // NVIDIA NVENC
    if (gpuData.nvidia && gpuData.nvidia.supported) {
        html += generateGpuCard('NVIDIA NVENC', gpuData.nvidia, 'success');
    }

    // Intel QSV
    if (gpuData.intel && gpuData.intel.supported) {
        html += generateGpuCard('Intel QSV', gpuData.intel, 'info');
    }

    // AMD AMF
    if (gpuData.amd && gpuData.amd.supported) {
        html += generateGpuCard('AMD AMF', gpuData.amd, 'warning');
    }

    html += `
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-clock"></i> 检测时间: ${new Date().toLocaleString()}
            </small>
        </div>
    `;

    gpuInfoDiv.innerHTML = html;
}

// 生成GPU卡片
function generateGpuCard(title, gpuInfo, variant) {
    const iconMap = {
        'NVIDIA NVENC': 'fas fa-microchip text-success',
        'Intel QSV': 'fas fa-microchip text-info',
        'AMD AMF': 'fas fa-microchip text-warning'
    };

    return `
        <div class="card mb-2 border-${variant}">
            <div class="card-body p-3">
                <h6 class="card-title">
                    <i class="${iconMap[title] || 'fas fa-microchip'}"></i> ${title}
                </h6>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">设备数量</small><br>
                        <span class="fw-bold">${gpuInfo.deviceCount || 0}</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">编码器数量</small><br>
                        <span class="fw-bold">${gpuInfo.encoders?.length || 0}</span>
                    </div>
                </div>
                ${gpuInfo.encoders && gpuInfo.encoders.length > 0 ? `
                    <div class="mt-2">
                        <small class="text-muted">支持的编码器:</small><br>
                        <div class="d-flex flex-wrap gap-1 mt-1">
                            ${gpuInfo.encoders.map(encoder =>
                                `<span class="badge bg-${variant}">${encoder}</span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// 获取支持的GPU类型列表
function getSupportedGpuTypes(gpuData) {
    const types = [];
    if (gpuData.nvidia?.supported) types.push('NVIDIA');
    if (gpuData.intel?.supported) types.push('Intel');
    if (gpuData.amd?.supported) types.push('AMD');
    return types.join(', ') || '无';
}

// 显示GPU错误信息
function displayGpuError(errorMessage) {
    const gpuInfoDiv = document.getElementById('gpuInfo');
    if (!gpuInfoDiv) return;

    gpuInfoDiv.innerHTML = `
        <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle"></i> GPU信息加载失败</h6>
            <p class="mb-2">${errorMessage}</p>
            <button class="btn btn-outline-primary btn-sm" onclick="loadGpuInfo()">
                <i class="fas fa-redo"></i> 重新检测
            </button>
        </div>
    `;
}
```

## 🛡️ 第七阶段：错误处理和优化

### 步骤7.1：实现全局错误处理

#### 任务清单
- [ ] 创建错误分类系统
- [ ] 实现错误恢复机制
- [ ] 添加故障排除建议
- [ ] 设置性能优化

#### 实现代码
```javascript
// 全局错误处理初始化
function initializeErrorHandling() {
    console.log('🛡️ 初始化错误处理系统...');

    // 设置全局错误监听器
    window.addEventListener('error', handleGlobalError);
    window.addEventListener('unhandledrejection', handleUnhandledRejection);

    // 设置页面卸载清理
    window.addEventListener('beforeunload', cleanupResources);
}

// 全局错误处理器
function handleGlobalError(event) {
    console.error('全局错误:', event.error);

    const error = event.error;
    const context = event.filename ? `${event.filename}:${event.lineno}` : '未知位置';

    handleError(error, context, { global: true });
}

// 未处理的Promise拒绝
function handleUnhandledRejection(event) {
    console.error('未处理的Promise拒绝:', event.reason);

    handleError(event.reason, 'Promise拒绝', { promise: true });
    event.preventDefault(); // 防止默认的错误处理
}

// 统一错误处理函数
function handleError(error, context, options = {}) {
    console.error(`错误发生在 ${context}:`, error);

    // 错误分类处理
    const errorType = classifyError(error);

    switch (errorType) {
        case 'NetworkError':
            handleNetworkError(error, context, options);
            break;
        case 'ValidationError':
            handleValidationError(error, context, options);
            break;
        case 'ServerError':
            handleServerError(error, context, options);
            break;
        case 'TimeoutError':
            handleTimeoutError(error, context, options);
            break;
        default:
            handleGenericError(error, context, options);
    }

    // 记录错误到控制台和可能的日志服务
    logError(error, context);
}

// 错误分类
function classifyError(error) {
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
        return 'NetworkError';
    }
    if (error.name === 'ValidationError' || error.status === 400) {
        return 'ValidationError';
    }
    if (error.status >= 500) {
        return 'ServerError';
    }
    if (error.name === 'TimeoutError' || error.code === 'TIMEOUT') {
        return 'TimeoutError';
    }
    return 'GenericError';
}

// 网络错误处理
function handleNetworkError(error, context, options) {
    showAlert('warning', '网络连接问题，请检查网络后重试');

    // 尝试重新连接SignalR
    if (context.includes('SignalR')) {
        setTimeout(() => {
            console.log('尝试重新连接SignalR...');
            startConnection();
        }, 5000);
    }
}

// 资源清理
function cleanupResources() {
    console.log('🧹 清理页面资源...');

    // 清理定时器
    if (window.taskTimer) {
        clearInterval(window.taskTimer);
    }

    // 断开SignalR连接
    if (connection && connection.state === signalR.HubConnectionState.Connected) {
        try {
            if (currentTaskId) {
                connection.invoke("LeaveTaskGroup", currentTaskId);
            }
            connection.stop();
        } catch (error) {
            console.error('关闭SignalR连接时出错:', error);
        }
    }
}

// 错误日志记录
function logError(error, context) {
    const errorLog = {
        timestamp: new Date().toISOString(),
        context: context,
        message: error.message,
        stack: error.stack,
        userAgent: navigator.userAgent,
        url: window.location.href
    };

    console.error('错误日志:', errorLog);

    // 可以发送到日志服务
    // sendErrorToLoggingService(errorLog);
}
```

## 🧪 第八阶段：测试和部署

### 步骤8.1：功能测试清单

#### 基础功能测试
- [ ] **文件上传测试**
  - [ ] 拖拽上传功能
  - [ ] 点击选择文件
  - [ ] 文件格式验证
  - [ ] 文件大小限制
  - [ ] 大文件上传进度

- [ ] **转换设置测试**
  - [ ] 预设选择功能
  - [ ] 智能GPU预设选择
  - [ ] 高级设置配置
  - [ ] 表单验证

- [ ] **SignalR通信测试**
  - [ ] 连接建立和断开
  - [ ] 自动重连机制
  - [ ] 实时进度更新
  - [ ] 事件处理

- [ ] **任务管理测试**
  - [ ] 任务开始显示
  - [ ] 进度实时更新
  - [ ] 任务完成处理
  - [ ] 任务失败处理
  - [ ] 任务操作按钮

- [ ] **GPU功能测试**
  - [ ] GPU信息检测
  - [ ] GPU状态显示
  - [ ] 刷新功能
  - [ ] 错误处理

#### 错误场景测试
- [ ] **网络错误测试**
  - [ ] 断网情况处理
  - [ ] 服务器不可用
  - [ ] 超时处理

- [ ] **文件错误测试**
  - [ ] 无效文件格式
  - [ ] 损坏的文件
  - [ ] 超大文件

- [ ] **转换错误测试**
  - [ ] 转换失败处理
  - [ ] 任务取消
  - [ ] 服务器错误

### 步骤8.2：性能优化检查

#### 性能优化清单
- [ ] **JavaScript优化**
  - [ ] 防抖和节流实现
  - [ ] 内存泄漏检查
  - [ ] 事件监听器清理
  - [ ] DOM操作优化

- [ ] **网络优化**
  - [ ] API请求优化
  - [ ] 缓存策略
  - [ ] 大文件上传优化

- [ ] **用户体验优化**
  - [ ] 加载状态显示
  - [ ] 错误提示友好性
  - [ ] 操作反馈及时性

### 步骤8.3：部署准备

#### 部署前检查
- [ ] **代码质量检查**
  - [ ] 代码格式化
  - [ ] 注释完整性
  - [ ] 错误处理覆盖
  - [ ] 日志记录

- [ ] **配置检查**
  - [ ] API端点配置
  - [ ] SignalR Hub配置
  - [ ] 文件上传限制
  - [ ] 安全设置

- [ ] **浏览器兼容性**
  - [ ] Chrome测试
  - [ ] Firefox测试
  - [ ] Edge测试
  - [ ] Safari测试

### 步骤8.4：完整的页面初始化函数

#### 最终初始化代码
```javascript
// 页面完整初始化函数
function initializePageComponents() {
    console.log('🎨 初始化页面组件...');

    try {
        // 1. 初始化基础工具函数
        setupUtilityFunctions();

        // 2. 初始化错误处理
        initializeErrorHandling();

        // 3. 初始化SignalR连接
        initializeSignalR();

        // 4. 初始化文件上传模块
        initializeFileUpload();

        // 5. 初始化表单提交处理
        initializeFormSubmission();

        // 6. 初始化任务管理
        initializeTaskManagement();

        // 7. 初始化GPU模块
        initializeGpuModule();

        // 8. 绑定全局事件
        bindGlobalEvents();

        console.log('✅ 所有页面组件初始化完成');

    } catch (error) {
        console.error('❌ 页面初始化失败:', error);
        showAlert('danger', '页面初始化失败，请刷新页面重试');
    }
}

// 绑定全局事件
function bindGlobalEvents() {
    console.log('🔗 绑定全局事件...');

    // 绑定任务操作按钮事件
    bindTaskActionButtons();

    // 绑定预设选择变化事件
    const presetSelect = document.getElementById('preset');
    if (presetSelect) {
        presetSelect.addEventListener('change', function() {
            updateAdvancedSettings(this.value);
        });
    }
}

// 绑定任务操作按钮事件
function bindTaskActionButtons() {
    // 取消任务按钮
    const cancelBtn = document.getElementById('cancelTask');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            if (currentTaskId) {
                cancelTask(currentTaskId);
            }
        });
    }

    // 刷新任务状态按钮
    const refreshBtn = document.getElementById('refreshTask');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (currentTaskId) {
                refreshTaskStatus(currentTaskId);
            }
        });
    }

    // 重新开始任务按钮
    const restartBtn = document.getElementById('restartTask');
    if (restartBtn) {
        restartBtn.addEventListener('click', function() {
            // 重置表单并重新开始
            const form = document.getElementById('conversionForm');
            if (form) {
                form.dispatchEvent(new Event('submit'));
            }
        });
    }
}

// 任务操作函数
async function cancelTask(taskId) {
    if (!taskId) return;

    try {
        const response = await fetch(`/api/conversion/cancel/${taskId}`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showAlert('success', '任务取消请求已发送');
        } else {
            throw new Error(result.message || '取消失败');
        }
    } catch (error) {
        console.error('取消任务失败:', error);
        showAlert('danger', '取消任务失败: ' + error.message);
    }
}

// 刷新任务状态
async function refreshTaskStatus(taskId) {
    if (!taskId || !connection || connection.state !== signalR.HubConnectionState.Connected) {
        showAlert('warning', '无法刷新任务状态：连接不可用');
        return;
    }

    try {
        await connection.invoke("GetTaskStatus", taskId);
        showAlert('info', '已请求刷新任务状态');
    } catch (error) {
        console.error('刷新任务状态失败:', error);
        showAlert('danger', '刷新失败: ' + error.message);
    }
}

// 加载最近任务
async function loadRecentTasks() {
    try {
        const response = await fetch('/api/conversion/recent?count=10');
        const result = await response.json();

        if (result.success) {
            displayRecentTasks(result.data);
        }
    } catch (error) {
        console.error('加载最近任务失败:', error);
    }
}

// 显示最近任务
function displayRecentTasks(tasks) {
    const recentTasksDiv = document.getElementById('recentTasks');
    if (!recentTasksDiv) return;

    if (!tasks || tasks.length === 0) {
        recentTasksDiv.innerHTML = '<p class="text-muted text-center">暂无最近任务</p>';
        return;
    }

    let html = '';
    tasks.forEach(task => {
        const statusClass = task.status === 'Completed' ? 'success' :
                           task.status === 'Failed' ? 'danger' :
                           task.status === 'Running' ? 'primary' : 'secondary';

        html += `
            <div class="card mb-2">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${task.fileName || task.taskName}</h6>
                            <small class="text-muted">${task.createdAt}</small>
                        </div>
                        <span class="badge bg-${statusClass}">${task.status}</span>
                    </div>
                    ${task.progress ? `
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar" style="width: ${task.progress}%"></div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });

    recentTasksDiv.innerHTML = html;
}

// 开始任务计时器
function startTaskTimer() {
    if (window.taskTimer) {
        clearInterval(window.taskTimer);
    }

    window.taskTimer = setInterval(() => {
        if (currentTaskStartTime) {
            const elapsedSeconds = Math.floor((new Date() - currentTaskStartTime) / 1000);
            const elapsedElement = document.getElementById('elapsedTime');
            if (elapsedElement) {
                elapsedElement.textContent = formatTime(elapsedSeconds);
            }
        }
    }, 1000);
}
```

## 📋 开发完成检查清单

### ✅ 功能完整性检查
- [ ] 文件上传模块完整实现
- [ ] SignalR通信模块正常工作
- [ ] 转换设置模块功能完善
- [ ] 任务管理模块状态正确
- [ ] GPU硬件加速模块检测准确
- [ ] 错误处理机制覆盖全面

### ✅ 代码质量检查
- [ ] 代码注释详细完整
- [ ] 函数命名清晰易懂
- [ ] 错误处理覆盖充分
- [ ] 性能优化措施到位
- [ ] 内存管理机制完善

### ✅ 用户体验检查
- [ ] 界面响应及时
- [ ] 操作反馈明确
- [ ] 错误提示友好
- [ ] 加载状态清晰
- [ ] 功能引导完善

### ✅ 安全性检查
- [ ] 文件上传验证严格
- [ ] 输入参数验证完整
- [ ] XSS防护措施
- [ ] CSRF保护机制

## 🎉 总结

通过以上8个阶段的详细开发步骤，您可以完整实现Index页面的所有功能：

1. **基础架构** - 建立了坚实的页面基础和工具函数
2. **文件上传** - 实现了完整的文件上传和验证机制
3. **SignalR通信** - 建立了可靠的实时通信系统
4. **转换设置** - 提供了智能的预设选择和配置功能
5. **任务管理** - 实现了完整的任务生命周期管理
6. **GPU硬件加速** - 提供了准确的GPU检测和显示
7. **错误处理** - 建立了完善的错误处理和恢复机制
8. **测试部署** - 确保了代码质量和用户体验

这个实现方案具备了生产环境所需的所有特性，包括性能优化、错误处理、用户体验和安全性考虑。
