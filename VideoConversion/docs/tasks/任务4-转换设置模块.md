# 任务4：转换设置模块

## 📋 任务概述

实现智能转换设置功能，包括GPU预设自动选择、高级设置配置和表单提交处理。

## 🎯 任务目标

- [ ] 创建转换设置界面
- [ ] 实现智能GPU预设选择
- [ ] 添加高级设置配置
- [ ] 处理表单提交逻辑

## 📝 详细任务清单

### 步骤4.1：创建转换设置界面

#### 任务清单
- [ ] 设计预设选择下拉框
- [ ] 创建高级设置手风琴
- [ ] 添加基本设置选项
- [ ] 实现视频和音频设置

#### 实现代码
```html
<!-- 转换设置区域 -->
<div id="conversionSettings" class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-cogs text-primary"></i>
            转换设置
        </h5>
    </div>
    <div class="card-body">
        <form id="conversionForm">
            <!-- 预设选择 -->
            <div class="mb-3">
                <label for="preset" class="form-label">转换预设</label>
                <select class="form-select" id="preset" name="preset" required>
                    <option value="">请选择预设...</option>
                    <option value="gpu_fast_1080p_nvenc">GPU Fast 1080p (NVENC)</option>
                    <option value="gpu_hq_1080p_nvenc">GPU High Quality 1080p (NVENC)</option>
                    <option value="gpu_4k_ultra_nvenc">GPU 4K Ultra (NVENC)</option>
                    <option value="gpu_fast_1080p_qsv">GPU Fast 1080p (QSV)</option>
                    <option value="gpu_hq_1080p_qsv">GPU High Quality 1080p (QSV)</option>
                    <option value="gpu_fast_1080p_amf">GPU Fast 1080p (AMF)</option>
                    <option value="gpu_hq_1080p_amf">GPU High Quality 1080p (AMF)</option>
                    <option value="cpu_standard_1080p">CPU Standard 1080p</option>
                    <option value="cpu_hq_1080p">CPU High Quality 1080p</option>
                </select>
                <div class="form-text">
                    <i class="fas fa-lightbulb text-warning"></i>
                    系统将根据您的GPU硬件自动推荐最佳预设
                </div>
            </div>
            
            <!-- 高级设置手风琴 -->
            <div class="accordion" id="advancedSettings">
                <!-- 基本设置 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#basicPanel">
                            <i class="fas fa-cogs"></i>&nbsp;基本设置
                        </button>
                    </h2>
                    <div id="basicPanel" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="outputFormat" class="form-label">输出格式</label>
                                    <select class="form-select" id="outputFormat" name="outputFormat">
                                        <option value="mp4">MP4 (H.264)</option>
                                        <option value="mp4_h265">MP4 (H.265/HEVC)</option>
                                        <option value="webm">WebM (VP9)</option>
                                        <option value="avi">AVI</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="resolution" class="form-label">分辨率</label>
                                    <select class="form-select" id="resolution" name="resolution">
                                        <option value="">保持原始</option>
                                        <option value="3840x2160">4K (3840x2160)</option>
                                        <option value="1920x1080">1080p (1920x1080)</option>
                                        <option value="1280x720">720p (1280x720)</option>
                                        <option value="854x480">480p (854x480)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 视频设置 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#videoPanel">
                            <i class="fas fa-video"></i>&nbsp;视频设置
                        </button>
                    </h2>
                    <div id="videoPanel" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="videoCodec" class="form-label">视频编解码器</label>
                                    <select class="form-select" id="videoCodec" name="videoCodec">
                                        <option value="libx264">H.264 (CPU)</option>
                                        <option value="h264_nvenc">H.264 (NVIDIA)</option>
                                        <option value="h264_qsv">H.264 (Intel QSV)</option>
                                        <option value="h264_amf">H.264 (AMD AMF)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="videoQuality" class="form-label">
                                        视频质量 <span id="qualityValue">23</span>
                                    </label>
                                    <input type="range" class="form-range" id="videoQuality" 
                                           name="videoQuality" min="18" max="28" value="23">
                                    <div class="form-text">较低值 = 更高质量，较高值 = 更小文件</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 音频设置 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#audioPanel">
                            <i class="fas fa-volume-up"></i>&nbsp;音频设置
                        </button>
                    </h2>
                    <div id="audioPanel" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="audioCodec" class="form-label">音频编解码器</label>
                                    <select class="form-select" id="audioCodec" name="audioCodec">
                                        <option value="aac">AAC</option>
                                        <option value="mp3">MP3</option>
                                        <option value="opus">Opus</option>
                                        <option value="copy">复制原始</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="audioBitrate" class="form-label">音频比特率</label>
                                    <select class="form-select" id="audioBitrate" name="audioBitrate">
                                        <option value="128k">128 kbps</option>
                                        <option value="192k">192 kbps</option>
                                        <option value="256k">256 kbps</option>
                                        <option value="320k">320 kbps</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 提交按钮 -->
            <div class="mt-4">
                <button type="submit" class="btn btn-primary btn-lg" id="startConversion">
                    <i class="fas fa-play"></i> 开始转换
                </button>
            </div>
        </form>
    </div>
</div>
```

### 步骤4.2：实现智能GPU预设选择

#### 任务清单
- [ ] 实现GPU能力检测
- [ ] 创建预设优先级映射
- [ ] 实现自动预设选择
- [ ] 添加预设选择通知

#### 实现代码
```javascript
// 智能预设选择初始化
async function initializeSmartPresetSelection() {
    try {
        console.log('🔍 开始智能GPU预设选择...');
        
        // 1. 检查GPU能力
        const gpuResponse = await fetch('/api/gpu/capabilities');
        const gpuData = await gpuResponse.json();
        
        if (gpuData.success && gpuData.data) {
            const capabilities = gpuData.data;
            console.log('GPU能力检测结果:', capabilities);
            
            // 2. 根据GPU类型选择预设
            if (capabilities.nvidia && capabilities.nvidia.supported) {
                selectBestGpuPreset('nvenc');
                console.log('✅ 自动选择NVIDIA GPU预设');
            } else if (capabilities.intel && capabilities.intel.supported) {
                selectBestGpuPreset('qsv');
                console.log('✅ 自动选择Intel GPU预设');
            } else if (capabilities.amd && capabilities.amd.supported) {
                selectBestGpuPreset('amf');
                console.log('✅ 自动选择AMD GPU预设');
            } else {
                console.log('ℹ️ 未检测到GPU支持，使用默认CPU预设');
                selectDefaultCpuPreset();
            }
        } else {
            console.log('⚠️ GPU检测失败，使用默认预设');
            selectDefaultCpuPreset();
        }
    } catch (error) {
        console.error('❌ 智能预设选择失败:', error);
        selectDefaultCpuPreset();
    }
}

// 选择最佳GPU预设
function selectBestGpuPreset(gpuType) {
    const presetSelect = document.getElementById('preset');
    if (!presetSelect) return;
    
    // 预设优先级映射
    const presetPriority = {
        'nvenc': [
            'gpu_fast_1080p_nvenc',
            'gpu_hq_1080p_nvenc',
            'gpu_4k_ultra_nvenc'
        ],
        'qsv': [
            'gpu_fast_1080p_qsv',
            'gpu_hq_1080p_qsv'
        ],
        'amf': [
            'gpu_fast_1080p_amf',
            'gpu_hq_1080p_amf'
        ]
    };
    
    const preferredPresets = presetPriority[gpuType] || [];
    
    // 按优先级查找并选择预设
    for (const presetValue of preferredPresets) {
        for (let i = 0; i < presetSelect.options.length; i++) {
            if (presetSelect.options[i].value === presetValue) {
                presetSelect.selectedIndex = i;
                updateAdvancedSettings(presetValue);
                
                // 显示GPU加速提示
                showGpuAccelNotification(presetSelect.options[i].text, gpuType);
                return;
            }
        }
    }
}

// 选择默认CPU预设
function selectDefaultCpuPreset() {
    const presetSelect = document.getElementById('preset');
    if (!presetSelect) return;
    
    // 查找CPU预设
    for (let i = 0; i < presetSelect.options.length; i++) {
        const optionValue = presetSelect.options[i].value;
        if (optionValue.includes('cpu')) {
            presetSelect.selectedIndex = i;
            updateAdvancedSettings(optionValue);
            break;
        }
    }
}

// 显示GPU加速通知
function showGpuAccelNotification(presetName, gpuType) {
    const gpuTypeMap = {
        'nvenc': 'NVIDIA',
        'qsv': 'Intel',
        'amf': 'AMD'
    };
    
    const gpuName = gpuTypeMap[gpuType] || gpuType;
    showAlert('info', `🚀 已启用${gpuName} GPU硬件加速，转换速度将显著提升！`);
}
```

### 步骤4.3：实现高级设置更新

#### 任务清单
- [ ] 创建预设配置映射
- [ ] 实现设置自动更新
- [ ] 添加设置验证
- [ ] 处理设置冲突

#### 实现代码
```javascript
// 更新高级设置
function updateAdvancedSettings(presetValue) {
    console.log('⚙️ 更新高级设置:', presetValue);
    
    // 根据预设值获取配置
    const presetConfig = getPresetConfiguration(presetValue);
    
    if (presetConfig) {
        // 更新输出格式
        if (presetConfig.outputFormat) {
            const outputFormat = document.getElementById('outputFormat');
            if (outputFormat) outputFormat.value = presetConfig.outputFormat;
        }
        
        // 更新视频编解码器
        if (presetConfig.videoCodec) {
            const videoCodec = document.getElementById('videoCodec');
            if (videoCodec) videoCodec.value = presetConfig.videoCodec;
        }
        
        // 更新质量设置
        if (presetConfig.quality) {
            const videoQuality = document.getElementById('videoQuality');
            const qualityValue = document.getElementById('qualityValue');
            if (videoQuality) videoQuality.value = presetConfig.quality;
            if (qualityValue) qualityValue.textContent = presetConfig.quality;
        }
        
        // 更新分辨率
        if (presetConfig.resolution) {
            const resolution = document.getElementById('resolution');
            if (resolution) resolution.value = presetConfig.resolution;
        }
        
        // 更新音频设置
        if (presetConfig.audioCodec) {
            const audioCodec = document.getElementById('audioCodec');
            if (audioCodec) audioCodec.value = presetConfig.audioCodec;
        }
        
        if (presetConfig.audioBitrate) {
            const audioBitrate = document.getElementById('audioBitrate');
            if (audioBitrate) audioBitrate.value = presetConfig.audioBitrate;
        }
    }
}

// 获取预设配置
function getPresetConfiguration(presetValue) {
    const presetConfigs = {
        'gpu_fast_1080p_nvenc': {
            outputFormat: 'mp4',
            videoCodec: 'h264_nvenc',
            resolution: '1920x1080',
            quality: 23,
            audioCodec: 'aac',
            audioBitrate: '192k'
        },
        'gpu_hq_1080p_nvenc': {
            outputFormat: 'mp4',
            videoCodec: 'h264_nvenc',
            resolution: '1920x1080',
            quality: 18,
            audioCodec: 'aac',
            audioBitrate: '256k'
        },
        'gpu_4k_ultra_nvenc': {
            outputFormat: 'mp4',
            videoCodec: 'h264_nvenc',
            resolution: '3840x2160',
            quality: 20,
            audioCodec: 'aac',
            audioBitrate: '320k'
        },
        'gpu_fast_1080p_qsv': {
            outputFormat: 'mp4',
            videoCodec: 'h264_qsv',
            resolution: '1920x1080',
            quality: 23,
            audioCodec: 'aac',
            audioBitrate: '192k'
        },
        'gpu_fast_1080p_amf': {
            outputFormat: 'mp4',
            videoCodec: 'h264_amf',
            resolution: '1920x1080',
            quality: 23,
            audioCodec: 'aac',
            audioBitrate: '192k'
        },
        'cpu_standard_1080p': {
            outputFormat: 'mp4',
            videoCodec: 'libx264',
            resolution: '1920x1080',
            quality: 23,
            audioCodec: 'aac',
            audioBitrate: '192k'
        },
        'cpu_hq_1080p': {
            outputFormat: 'mp4',
            videoCodec: 'libx264',
            resolution: '1920x1080',
            quality: 18,
            audioCodec: 'aac',
            audioBitrate: '256k'
        }
    };
    
    return presetConfigs[presetValue] || null;
}
```

### 步骤4.4：实现表单提交处理

#### 任务清单
- [ ] 绑定表单提交事件
- [ ] 实现表单数据验证
- [ ] 处理大文件上传逻辑
- [ ] 添加提交状态管理

#### 实现代码
```javascript
// 表单提交处理初始化
function initializeFormSubmission() {
    console.log('📝 初始化表单提交处理...');
    
    const form = document.getElementById('conversionForm');
    if (form) {
        form.addEventListener('submit', handleFormSubmit);
    }
    
    // 绑定预设选择变化事件
    const presetSelect = document.getElementById('preset');
    if (presetSelect) {
        presetSelect.addEventListener('change', function() {
            updateAdvancedSettings(this.value);
        });
    }
    
    // 绑定质量滑块事件
    const qualitySlider = document.getElementById('videoQuality');
    const qualityValue = document.getElementById('qualityValue');
    if (qualitySlider && qualityValue) {
        qualitySlider.addEventListener('input', function() {
            qualityValue.textContent = this.value;
        });
    }
}

// 表单提交处理
async function handleFormSubmit(e) {
    e.preventDefault();
    
    console.log('📤 处理表单提交...');
    
    const fileInput = document.getElementById('videoFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('warning', '请选择要转换的视频文件');
        return;
    }
    
    // 验证表单数据
    if (!validateFormData()) {
        return;
    }
    
    // 创建FormData
    const formData = new FormData(e.target);
    
    try {
        // 更新提交按钮状态
        updateSubmitButtonState('submitting');
        
        // 检查文件大小，决定使用哪种上传方式
        const isLargeFile = file.size > 100 * 1024 * 1024; // 100MB
        
        let result;
        if (isLargeFile) {
            result = await handleLargeFileUpload(file, formData);
        } else {
            result = await handleNormalFileUpload(formData);
        }
        
        if (result.success) {
            showAlert('success', '转换任务已提交');
            // 任务开始事件会通过SignalR接收
        } else {
            throw new Error(result.message || '提交失败');
        }
    } catch (error) {
        console.error('表单提交失败:', error);
        showAlert('danger', '提交失败: ' + error.message);
    } finally {
        // 恢复提交按钮状态
        updateSubmitButtonState('normal');
    }
}

// 验证表单数据
function validateFormData() {
    const preset = document.getElementById('preset').value;
    if (!preset) {
        showAlert('warning', '请选择转换预设');
        return false;
    }
    
    return true;
}

// 普通文件上传
async function handleNormalFileUpload(formData) {
    console.log('📤 处理普通文件上传...');
    
    const response = await fetch('/api/conversion/start', {
        method: 'POST',
        body: formData
    });
    
    return await response.json();
}

// 更新提交按钮状态
function updateSubmitButtonState(state) {
    const button = document.getElementById('startConversion');
    if (!button) return;
    
    switch (state) {
        case 'submitting':
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
            break;
        case 'normal':
        default:
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-play"></i> 开始转换';
            break;
    }
}
```

## ✅ 验收标准

### 功能验收
- [ ] 智能预设选择正常工作
- [ ] 高级设置正确更新
- [ ] 表单提交功能正常
- [ ] 数据验证有效

### 用户体验验收
- [ ] 预设选择响应及时
- [ ] 设置界面友好易用
- [ ] 错误提示清晰明确
- [ ] 操作流程顺畅

### 兼容性验收
- [ ] 支持各种GPU类型
- [ ] 预设配置准确
- [ ] 浏览器兼容性良好

## 🔗 依赖关系

### 前置依赖
- 任务1：基础架构搭建
- 任务2：文件上传模块
- 任务3：SignalR通信模块

### 后续任务
- 任务5：任务管理模块
- 任务6：GPU硬件加速模块

## 📊 预估工时

- **开发时间**: 4-5小时
- **测试时间**: 2小时
- **总计**: 6-7小时

## 🚨 注意事项

1. **预设准确性**: 确保预设配置与实际GPU能力匹配
2. **用户体验**: 智能选择应该对用户透明且可控
3. **数据验证**: 严格验证用户输入的设置参数
4. **性能考虑**: 避免频繁的设置更新影响性能

## 📝 完成标记

- [ ] 步骤4.1完成
- [ ] 步骤4.2完成
- [ ] 步骤4.3完成
- [ ] 步骤4.4完成
- [ ] 验收测试通过
- [ ] 代码提交完成

**完成时间**: ___________  
**开发者**: ___________  
**审核者**: ___________
