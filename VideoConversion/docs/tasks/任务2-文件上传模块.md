# 任务2：文件上传模块

## 📋 任务概述

实现完整的文件上传功能，包括拖拽上传、文件验证、大文件处理和上传进度显示。

## 🎯 任务目标

- [ ] 实现拖拽上传功能
- [ ] 添加文件格式和大小验证
- [ ] 支持大文件上传处理
- [ ] 显示上传进度和状态

## 📝 详细任务清单

### 步骤2.1：创建文件上传界面

#### 任务清单
- [ ] 设计拖拽上传区域
- [ ] 添加文件选择按钮
- [ ] 创建文件信息显示区域
- [ ] 添加上传进度显示

#### 实现代码
```html
<!-- 文件上传区域 -->
<div id="fileUploadSection" class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-upload text-primary"></i>
            文件上传
        </h5>
    </div>
    <div class="card-body">
        <!-- 拖拽上传区域 -->
        <div class="file-drop-zone border-dashed p-4 text-center" id="fileDropZone">
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <p class="mb-2">拖拽视频文件到此处或点击选择文件</p>
            <input type="file" class="form-control" id="videoFile" name="videoFile" 
                   accept=".mp4,.avi,.mov,.mkv,.wmv,.flv,.webm,.m4v" required>
            <small class="text-muted">
                支持格式: MP4, AVI, MOV, MKV, WMV, FLV, WebM, M4V (最大2GB)
            </small>
        </div>
        
        <!-- 文件信息显示 -->
        <div id="selectedFileInfo" style="display: none;" class="mt-3">
            <div class="alert alert-info">
                <h6><i class="fas fa-file-video"></i> 已选择文件</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>文件名:</strong> <span id="selectedFileName"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>大小:</strong> <span id="selectedFileSize"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 上传进度显示 -->
        <div id="uploadProgressContainer" style="display: none;" class="mt-3">
            <div class="card border-primary">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-upload text-primary"></i>
                        文件上传进度
                    </h6>
                </div>
                <div class="card-body">
                    <div class="progress mb-2" style="height: 20px;">
                        <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="row text-muted small">
                        <div class="col-4">
                            <i class="fas fa-percentage"></i>
                            <span id="uploadPercentage">0%</span>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-tachometer-alt"></i>
                            <span id="uploadSpeed">0 MB/s</span>
                        </div>
                        <div class="col-4">
                            <i class="fas fa-clock"></i>
                            <span id="uploadTimeRemaining">计算中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

### 步骤2.2：实现文件选择和验证

#### 任务清单
- [ ] 绑定文件选择事件
- [ ] 实现文件格式验证
- [ ] 添加文件大小检查
- [ ] 显示文件信息

#### 实现代码
```javascript
// 文件上传模块初始化
function initializeFileUpload() {
    console.log('📁 初始化文件上传模块...');
    
    const fileInput = document.getElementById('videoFile');
    const dropZone = document.getElementById('fileDropZone');
    
    // 绑定文件选择事件
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });
    }
    
    // 初始化拖拽功能
    if (dropZone) {
        initializeFileDragDrop();
    }
}

// 文件选择处理
function handleFileSelection(file) {
    console.log('📄 处理文件选择:', file.name);
    
    // 文件验证
    if (!validateFile(file)) {
        return;
    }
    
    // 显示文件信息
    displayFileInfo(file);
    
    // 触发智能预设选择
    initializeSmartPresetSelection();
}

// 文件验证
function validateFile(file) {
    console.log('🔍 验证文件:', file.name);
    
    // 检查文件类型
    const allowedExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm', '.m4v'];
    const fileName = file.name.toLowerCase();
    const isValidType = allowedExtensions.some(ext => fileName.endsWith(ext));
    
    if (!isValidType) {
        showAlert('danger', `不支持的文件格式。支持的格式: ${allowedExtensions.join(', ')}`);
        return false;
    }
    
    // 检查文件大小 (2GB限制)
    const maxSize = 2 * 1024 * 1024 * 1024; // 2GB
    if (file.size > maxSize) {
        showAlert('danger', `文件大小超过限制: ${formatFileSize(file.size)} > ${formatFileSize(maxSize)}`);
        return false;
    }
    
    // 检查最小文件大小
    if (file.size < 1024) {
        showAlert('danger', '文件太小，可能不是有效的视频文件');
        return false;
    }
    
    console.log('✅ 文件验证通过');
    return true;
}

// 显示文件信息
function displayFileInfo(file) {
    console.log('📋 显示文件信息');
    
    const fileInfoDiv = document.getElementById('selectedFileInfo');
    const fileName = document.getElementById('selectedFileName');
    const fileSize = document.getElementById('selectedFileSize');
    
    if (fileName) fileName.textContent = file.name;
    if (fileSize) fileSize.textContent = formatFileSize(file.size);
    if (fileInfoDiv) fileInfoDiv.style.display = 'block';
}
```

### 步骤2.3：实现拖拽上传功能

#### 任务清单
- [ ] 绑定拖拽事件监听器
- [ ] 实现拖拽视觉反馈
- [ ] 处理文件拖拽释放
- [ ] 防止默认浏览器行为

#### 实现代码
```javascript
// 拖拽功能初始化
function initializeFileDragDrop() {
    console.log('🎯 初始化拖拽上传功能...');
    
    const dropZone = document.getElementById('fileDropZone');
    
    // 防止默认拖拽行为
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // 拖拽进入/离开视觉反馈
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    // 文件拖拽处理
    dropZone.addEventListener('drop', handleDrop, false);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight(e) {
    e.currentTarget.classList.add('dragover');
}

function unhighlight(e) {
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        const fileInput = document.getElementById('videoFile');
        fileInput.files = files;
        handleFileSelection(files[0]);
    }
}
```

### 步骤2.4：实现大文件上传处理

#### 任务清单
- [ ] 检测文件大小阈值
- [ ] 实现大文件上传API调用
- [ ] 添加上传进度跟踪
- [ ] 处理上传错误

#### 实现代码
```javascript
// 大文件上传处理
async function handleLargeFileUpload(file, formData) {
    console.log('📤 处理大文件上传:', file.name);
    
    const isLargeFile = file.size > 100 * 1024 * 1024; // 100MB阈值
    
    if (isLargeFile) {
        console.log('🔄 使用大文件上传API');
        
        // 显示上传进度
        showUploadProgress();
        
        try {
            const response = await fetch('/api/upload/large-file', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('✅ 大文件上传成功');
                hideUploadProgress();
                return result;
            } else {
                throw new Error(result.message || '上传失败');
            }
        } catch (error) {
            console.error('❌ 大文件上传失败:', error);
            hideUploadProgress();
            throw error;
        }
    } else {
        console.log('📤 使用标准上传方式');
        return await handleNormalUpload(formData);
    }
}

// 显示上传进度
function showUploadProgress() {
    const container = document.getElementById('uploadProgressContainer');
    if (container) {
        container.style.display = 'block';
    }
}

// 隐藏上传进度
function hideUploadProgress() {
    const container = document.getElementById('uploadProgressContainer');
    if (container) {
        container.style.display = 'none';
    }
}

// 更新上传进度
function updateUploadProgress(data) {
    const progressBar = document.getElementById('uploadProgressBar');
    const percentage = document.getElementById('uploadPercentage');
    const speed = document.getElementById('uploadSpeed');
    const timeRemaining = document.getElementById('uploadTimeRemaining');
    
    if (progressBar && data.Progress) {
        progressBar.style.width = `${data.Progress}%`;
        progressBar.setAttribute('aria-valuenow', data.Progress);
    }
    
    if (percentage && data.Progress) {
        percentage.textContent = `${data.Progress}%`;
    }
    
    if (speed && data.Speed) {
        speed.textContent = formatFileSize(data.Speed) + '/s';
    }
    
    if (timeRemaining && data.EstimatedTimeRemaining) {
        timeRemaining.textContent = formatTime(data.EstimatedTimeRemaining);
    }
}
```

## ✅ 验收标准

### 功能验收
- [ ] 拖拽上传正常工作
- [ ] 文件选择功能正常
- [ ] 文件验证准确有效
- [ ] 大文件上传支持
- [ ] 进度显示实时更新

### 用户体验验收
- [ ] 拖拽视觉反馈清晰
- [ ] 错误提示友好明确
- [ ] 上传进度显示准确
- [ ] 操作响应及时

### 安全性验收
- [ ] 文件类型验证严格
- [ ] 文件大小限制有效
- [ ] 恶意文件防护
- [ ] 输入参数验证

## 🔗 依赖关系

### 前置依赖
- 任务1：基础架构搭建

### 后续任务
- 任务3：SignalR通信模块
- 任务4：转换设置模块

## 📊 预估工时

- **开发时间**: 4-5小时
- **测试时间**: 2小时
- **总计**: 6-7小时

## 🚨 注意事项

1. **文件安全**: 严格验证文件类型和大小
2. **性能优化**: 大文件上传时避免阻塞UI
3. **错误处理**: 完善的上传失败处理机制
4. **用户体验**: 清晰的进度反馈和状态提示

## 📝 完成标记

- [ ] 步骤2.1完成
- [ ] 步骤2.2完成
- [ ] 步骤2.3完成
- [ ] 步骤2.4完成
- [ ] 验收测试通过
- [ ] 代码提交完成

**完成时间**: ___________  
**开发者**: ___________  
**审核者**: ___________
