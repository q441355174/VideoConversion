# 任务5：任务管理模块

## 📋 任务概述

实现完整的任务生命周期管理，包括任务状态显示、进度跟踪、操作控制和最近任务列表。

## 🎯 任务目标

- [ ] 创建任务显示界面
- [ ] 实现任务状态管理
- [ ] 添加任务操作功能
- [ ] 显示最近任务列表

## 📝 详细任务清单

### 步骤5.1：创建任务显示界面

#### 任务清单
- [ ] 设计当前任务显示区域
- [ ] 创建进度条和状态显示
- [ ] 添加任务操作按钮
- [ ] 实现最近任务列表

#### 实现代码
```html
<!-- 当前任务显示区域 -->
<div id="currentTaskSection" class="card mb-4" style="display: none;">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
            <i class="fas fa-cog fa-spin"></i>
            当前转换任务
        </h6>
    </div>
    <div class="card-body">
        <!-- 任务基本信息 -->
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
                <span id="currentTaskName">任务名称</span>
            </h6>
            <small class="text-muted" id="taskId">任务ID</small>
        </div>
        
        <!-- 文件信息 -->
        <div class="row mb-3" id="fileInfo" style="display: none;">
            <div class="col-6">
                <small class="text-muted">原始文件</small><br>
                <span id="originalFileName" class="fw-bold"></span>
            </div>
            <div class="col-6">
                <small class="text-muted">输出格式</small><br>
                <span id="outputFormat" class="fw-bold"></span>
            </div>
        </div>
        
        <!-- 进度条 -->
        <div class="progress mb-3" style="height: 25px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <span class="fw-bold">0%</span>
            </div>
        </div>
        
        <!-- 详细状态信息 -->
        <div class="row text-center mb-3">
            <div class="col-3">
                <small class="text-muted">转换速度</small><br>
                <span id="conversionSpeed" class="fw-bold">-</span>
            </div>
            <div class="col-3">
                <small class="text-muted">剩余时间</small><br>
                <span id="remainingTime" class="fw-bold">-</span>
            </div>
            <div class="col-3">
                <small class="text-muted">已用时间</small><br>
                <span id="elapsedTime" class="fw-bold">-</span>
            </div>
            <div class="col-3">
                <small class="text-muted">文件大小</small><br>
                <span id="fileSize" class="fw-bold">-</span>
            </div>
        </div>
        
        <!-- 当前状态 -->
        <div class="alert alert-info mb-3" role="alert" id="taskStatusAlert">
            <i class="fas fa-info-circle"></i>
            <span id="taskStatus">等待中...</span>
        </div>
        
        <!-- 操作按钮 -->
        <div class="d-flex gap-2" id="taskActionButtons">
            <button type="button" class="btn btn-outline-danger btn-sm" id="cancelTask">
                <i class="fas fa-stop"></i> 取消转换
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" id="refreshTask" style="display: none;">
                <i class="fas fa-sync"></i> 刷新状态
            </button>
            <a class="btn btn-outline-success btn-sm" id="downloadTask" style="display: none;">
                <i class="fas fa-download"></i> 下载文件
            </a>
            <button type="button" class="btn btn-outline-primary btn-sm" id="restartTask" style="display: none;">
                <i class="fas fa-redo"></i> 重新开始
            </button>
        </div>
    </div>
</div>

<!-- 最近任务列表 -->
<div id="recentTasksSection" class="card">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-history text-secondary"></i>
            最近任务
        </h6>
    </div>
    <div class="card-body">
        <div id="recentTasks">
            <p class="text-muted text-center">暂无最近任务</p>
        </div>
    </div>
</div>
```

### 步骤5.2：实现任务状态管理

#### 任务清单
- [ ] 实现任务开始处理
- [ ] 添加进度更新逻辑
- [ ] 处理任务完成和失败
- [ ] 实现任务操作功能

#### 实现代码
```javascript
// 任务管理模块初始化
function initializeTaskManagement() {
    console.log('📊 初始化任务管理模块...');
    
    // 绑定任务操作按钮事件
    bindTaskActionButtons();
    
    // 加载最近任务
    loadRecentTasks();
}

// 任务开始处理
function handleTaskStarted(data) {
    console.log('🚀 任务开始:', data);
    
    currentTaskId = data.taskId;
    currentTaskStartTime = new Date();
    
    // 显示当前任务
    showCurrentTask(data);
    
    // 加入任务组以接收进度更新
    joinTaskGroup(data.taskId);
    
    // 开始计时
    startTaskTimer();
    
    // 更新UI状态
    updateTaskActionButtons('running');
    
    // 显示通知
    showAlert('info', `转换任务已开始: ${data.fileName || data.taskId}`);
}

// 显示当前任务
function showCurrentTask(data) {
    console.log('📋 显示当前任务');
    
    const currentTaskSection = document.getElementById('currentTaskSection');
    const taskName = document.getElementById('currentTaskName');
    const taskIdElement = document.getElementById('taskId');
    const originalFileName = document.getElementById('originalFileName');
    const fileInfo = document.getElementById('fileInfo');
    
    // 更新任务信息
    if (taskName) taskName.textContent = data.fileName || data.taskId;
    if (taskIdElement) taskIdElement.textContent = data.taskId;
    
    // 显示文件信息
    if (data.fileName && originalFileName) {
        originalFileName.textContent = data.fileName;
        if (fileInfo) fileInfo.style.display = 'block';
    }
    
    // 重置进度条
    resetProgressBar();
    
    // 显示任务容器
    if (currentTaskSection) {
        currentTaskSection.style.display = 'block';
    }
}

// 重置进度条
function resetProgressBar() {
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated';
        const span = progressBar.querySelector('span');
        if (span) span.textContent = '0%';
    }
}

// 进度更新处理
function updateProgress(data) {
    if (!data || !data.taskId || data.taskId !== currentTaskId) return;
    
    console.log('📊 更新进度:', data.progress + '%');
    
    // 更新进度条
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = `${data.progress}%`;
        progressBar.setAttribute('aria-valuenow', data.progress);
        const span = progressBar.querySelector('span');
        if (span) span.textContent = `${data.progress}%`;
    }
    
    // 更新详细信息
    updateTaskDetails(data);
    
    // 更新最近任务列表中的进度
    updateRecentTaskProgress(data.taskId, data.progress);
}

// 更新任务详细信息
function updateTaskDetails(data) {
    // 更新转换速度
    if (data.speed) {
        const speedElement = document.getElementById('conversionSpeed');
        if (speedElement) speedElement.textContent = data.speed;
    }
    
    // 更新剩余时间
    if (data.remainingSeconds) {
        const remainingElement = document.getElementById('remainingTime');
        if (remainingElement) {
            remainingElement.textContent = formatTime(data.remainingSeconds);
        }
    }
    
    // 更新已用时间
    if (currentTaskStartTime) {
        const elapsedSeconds = Math.floor((new Date() - currentTaskStartTime) / 1000);
        const elapsedElement = document.getElementById('elapsedTime');
        if (elapsedElement) {
            elapsedElement.textContent = formatTime(elapsedSeconds);
        }
    }
    
    // 更新状态消息
    if (data.message) {
        const statusElement = document.getElementById('taskStatus');
        if (statusElement) statusElement.textContent = data.message;
    }
}

// 任务完成处理
function handleTaskCompleted(data) {
    console.log('✅ 任务完成:', data);
    
    currentTaskId = null;
    currentTaskStartTime = null;
    
    // 更新进度条为100%
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.setAttribute('aria-valuenow', '100');
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        const span = progressBar.querySelector('span');
        if (span) span.textContent = '100%';
    }
    
    // 更新状态
    updateTaskStatus('转换完成！', 'success');
    
    // 显示下载按钮
    if (data.downloadUrl) {
        showDownloadButton(data.downloadUrl, data.fileName);
    }
    
    // 更新操作按钮
    updateTaskActionButtons('completed');
    
    // 刷新最近任务列表
    loadRecentTasks();
    
    // 显示成功消息
    const duration = data.duration ? ` (耗时: ${formatTime(data.duration)})` : '';
    showAlert('success', `转换完成: ${data.fileName || data.taskId}${duration}`);
}

// 任务失败处理
function handleTaskFailed(data) {
    console.log('❌ 任务失败:', data);
    
    currentTaskId = null;
    currentTaskStartTime = null;
    
    // 更新进度条样式
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-danger');
    }
    
    // 更新状态
    updateTaskStatus(`转换失败: ${data.error || '未知错误'}`, 'danger');
    
    // 更新操作按钮
    updateTaskActionButtons('failed');
    
    // 刷新最近任务列表
    loadRecentTasks();
    
    // 显示错误消息
    showAlert('danger', `转换失败: ${data.fileName || data.taskId} - ${data.error || '未知错误'}`);
}
```

### 步骤5.3：实现任务操作功能

#### 任务清单
- [ ] 绑定操作按钮事件
- [ ] 实现任务取消功能
- [ ] 添加任务状态刷新
- [ ] 处理任务重启

#### 实现代码
```javascript
// 绑定任务操作按钮事件
function bindTaskActionButtons() {
    // 取消任务按钮
    const cancelBtn = document.getElementById('cancelTask');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            if (currentTaskId) {
                cancelCurrentTask();
            }
        });
    }
    
    // 刷新任务状态按钮
    const refreshBtn = document.getElementById('refreshTask');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            if (currentTaskId) {
                refreshTaskStatus(currentTaskId);
            }
        });
    }
    
    // 重新开始任务按钮
    const restartBtn = document.getElementById('restartTask');
    if (restartBtn) {
        restartBtn.addEventListener('click', function() {
            restartTask();
        });
    }
}

// 取消当前任务
async function cancelCurrentTask() {
    if (!currentTaskId) return;
    
    try {
        const result = await SignalRInvoker.invoke("CancelTask", currentTaskId);
        
        if (result && result.success) {
            showAlert('info', '任务取消请求已发送');
        } else {
            throw new Error(result?.message || '取消失败');
        }
    } catch (error) {
        console.error('取消任务失败:', error);
        showAlert('danger', '取消任务失败: ' + error.message);
    }
}

// 刷新任务状态
async function refreshTaskStatus(taskId) {
    if (!taskId || connection.state !== signalR.HubConnectionState.Connected) {
        showAlert('warning', '无法刷新任务状态：连接不可用');
        return;
    }
    
    try {
        await SignalRInvoker.invoke("GetTaskStatus", taskId);
        showAlert('info', '已请求刷新任务状态');
    } catch (error) {
        console.error('刷新任务状态失败:', error);
        showAlert('danger', '刷新失败: ' + error.message);
    }
}

// 重启任务
function restartTask() {
    // 重置表单并重新开始
    const form = document.getElementById('conversionForm');
    if (form) {
        // 清除当前任务显示
        hideCurrentTask();
        
        // 重新提交表单
        form.dispatchEvent(new Event('submit'));
    }
}

// 隐藏当前任务
function hideCurrentTask() {
    const currentTaskSection = document.getElementById('currentTaskSection');
    if (currentTaskSection) {
        currentTaskSection.style.display = 'none';
    }
    
    currentTaskId = null;
    currentTaskStartTime = null;
    
    // 清理计时器
    if (window.taskTimer) {
        clearInterval(window.taskTimer);
        window.taskTimer = null;
    }
}

// 更新任务状态显示
function updateTaskStatus(message, type) {
    const statusAlert = document.getElementById('taskStatusAlert');
    const statusElement = document.getElementById('taskStatus');
    
    if (statusElement) statusElement.textContent = message;
    if (statusAlert) {
        statusAlert.className = `alert alert-${type} mb-3`;
    }
}

// 显示下载按钮
function showDownloadButton(downloadUrl, fileName) {
    const downloadBtn = document.getElementById('downloadTask');
    if (downloadBtn) {
        downloadBtn.href = downloadUrl;
        downloadBtn.download = fileName || 'converted_video';
        downloadBtn.style.display = 'inline-block';
    }
}

// 更新任务操作按钮状态
function updateTaskActionButtons(status) {
    const cancelBtn = document.getElementById('cancelTask');
    const refreshBtn = document.getElementById('refreshTask');
    const downloadBtn = document.getElementById('downloadTask');
    const restartBtn = document.getElementById('restartTask');
    
    // 隐藏所有按钮
    [cancelBtn, refreshBtn, downloadBtn, restartBtn].forEach(btn => {
        if (btn) btn.style.display = 'none';
    });
    
    // 根据状态显示相应按钮
    switch (status) {
        case 'running':
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
            if (refreshBtn) refreshBtn.style.display = 'inline-block';
            break;
        case 'completed':
            if (downloadBtn) downloadBtn.style.display = 'inline-block';
            if (restartBtn) restartBtn.style.display = 'inline-block';
            break;
        case 'failed':
            if (refreshBtn) refreshBtn.style.display = 'inline-block';
            if (restartBtn) restartBtn.style.display = 'inline-block';
            break;
    }
}
```

### 步骤5.4：实现最近任务列表

#### 任务清单
- [ ] 加载最近任务数据
- [ ] 显示任务列表
- [ ] 更新任务进度
- [ ] 处理任务点击事件

#### 实现代码
```javascript
// 加载最近任务
async function loadRecentTasks() {
    try {
        const response = await fetch('/api/conversion/recent?count=10');
        const result = await response.json();
        
        if (result.success) {
            displayRecentTasks(result.data);
        }
    } catch (error) {
        console.error('加载最近任务失败:', error);
    }
}

// 显示最近任务
function displayRecentTasks(tasks) {
    const recentTasksDiv = document.getElementById('recentTasks');
    if (!recentTasksDiv) return;
    
    if (!tasks || tasks.length === 0) {
        recentTasksDiv.innerHTML = '<p class="text-muted text-center">暂无最近任务</p>';
        return;
    }
    
    let html = '';
    tasks.forEach(task => {
        const statusClass = getTaskStatusClass(task.status);
        const statusIcon = getTaskStatusIcon(task.status);
        
        html += `
            <div class="card mb-2 task-item" data-task-id="${task.taskId}">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1">${task.fileName || task.taskName}</h6>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${formatDateTime(task.createdAt)}
                            </small>
                        </div>
                        <span class="badge bg-${statusClass}">
                            <i class="fas fa-${statusIcon}"></i> ${task.status}
                        </span>
                    </div>
                    ${task.progress !== undefined ? `
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-${statusClass}" 
                                 style="width: ${task.progress}%"></div>
                        </div>
                        <small class="text-muted">${task.progress}% 完成</small>
                    ` : ''}
                    ${task.downloadUrl ? `
                        <div class="mt-2">
                            <a href="${task.downloadUrl}" class="btn btn-outline-success btn-sm" 
                               download="${task.fileName}">
                                <i class="fas fa-download"></i> 下载
                            </a>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    recentTasksDiv.innerHTML = html;
    
    // 绑定任务点击事件
    bindRecentTaskEvents();
}

// 获取任务状态样式类
function getTaskStatusClass(status) {
    const statusMap = {
        'Completed': 'success',
        'Failed': 'danger',
        'Running': 'primary',
        'Pending': 'warning',
        'Cancelled': 'secondary'
    };
    return statusMap[status] || 'secondary';
}

// 获取任务状态图标
function getTaskStatusIcon(status) {
    const iconMap = {
        'Completed': 'check-circle',
        'Failed': 'exclamation-triangle',
        'Running': 'cog fa-spin',
        'Pending': 'clock',
        'Cancelled': 'times-circle'
    };
    return iconMap[status] || 'question-circle';
}

// 格式化日期时间
function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// 绑定最近任务事件
function bindRecentTaskEvents() {
    const taskItems = document.querySelectorAll('.task-item');
    taskItems.forEach(item => {
        item.addEventListener('click', function() {
            const taskId = this.dataset.taskId;
            if (taskId) {
                showTaskDetails(taskId);
            }
        });
    });
}

// 显示任务详情
function showTaskDetails(taskId) {
    // 可以实现任务详情弹窗或跳转到详情页面
    console.log('显示任务详情:', taskId);
}

// 更新最近任务中的进度
function updateRecentTaskProgress(taskId, progress) {
    const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
    if (taskItem) {
        const progressBar = taskItem.querySelector('.progress-bar');
        const progressText = taskItem.querySelector('small');
        
        if (progressBar) {
            progressBar.style.width = `${progress}%`;
        }
        
        if (progressText) {
            progressText.textContent = `${progress}% 完成`;
        }
    }
}

// 开始任务计时器
function startTaskTimer() {
    if (window.taskTimer) {
        clearInterval(window.taskTimer);
    }
    
    window.taskTimer = setInterval(() => {
        if (currentTaskStartTime) {
            const elapsedSeconds = Math.floor((new Date() - currentTaskStartTime) / 1000);
            const elapsedElement = document.getElementById('elapsedTime');
            if (elapsedElement) {
                elapsedElement.textContent = formatTime(elapsedSeconds);
            }
        }
    }, 1000);
}
```

## ✅ 验收标准

### 功能验收
- [ ] 任务状态正确显示
- [ ] 进度更新实时准确
- [ ] 任务操作功能正常
- [ ] 最近任务列表正确

### 用户体验验收
- [ ] 界面响应及时
- [ ] 状态变化清晰
- [ ] 操作反馈明确
- [ ] 错误处理友好

### 性能验收
- [ ] 进度更新不卡顿
- [ ] 内存使用合理
- [ ] 定时器正确清理

## 🔗 依赖关系

### 前置依赖
- 任务1：基础架构搭建
- 任务3：SignalR通信模块

### 后续任务
- 任务6：GPU硬件加速模块
- 任务7：错误处理和优化

## 📊 预估工时

- **开发时间**: 5-6小时
- **测试时间**: 2小时
- **总计**: 7-8小时

## 🚨 注意事项

1. **状态同步**: 确保任务状态与服务器端同步
2. **内存管理**: 及时清理定时器和事件监听器
3. **用户体验**: 提供清晰的任务状态反馈
4. **错误处理**: 完善的任务失败处理机制

## 📝 完成标记

- [ ] 步骤5.1完成
- [ ] 步骤5.2完成
- [ ] 步骤5.3完成
- [ ] 步骤5.4完成
- [ ] 验收测试通过
- [ ] 代码提交完成

**完成时间**: ___________  
**开发者**: ___________  
**审核者**: ___________
