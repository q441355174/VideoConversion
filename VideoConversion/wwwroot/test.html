<!DOCTYPE html >
<meta charset="utf-8"></meta>
<html>
<head>
    <title>APIæµ‹è¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 20px; margin: 5px; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>VideoConversion API æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h3>1. åŸºç¡€è¿æ¥æµ‹è¯•</h3>
        <button onclick="testHealth()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
        <button onclick="testRecent()">æµ‹è¯•æœ€è¿‘ä»»åŠ¡</button>
    </div>
    
    <div class="test-section">
        <h3>2. SignalRè¿æ¥æµ‹è¯•</h3>
        <button onclick="testSignalR()">æµ‹è¯•SignalRè¿æ¥</button>
        <button onclick="disconnectSignalR()">æ–­å¼€SignalR</button>
    </div>
    
    <div class="test-section">
        <h3>3. æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
        <input type="file" id="testFile" accept="video/*,.mkv,.mp4,.avi,.mov,.wmv,.flv,.webm,.m4v,.3gp">
        <button onclick="testUpload()">æµ‹è¯•æ–‡ä»¶ä¸Šä¼ </button>
        <button onclick="testFileValidation()">æµ‹è¯•æ–‡ä»¶éªŒè¯</button>
        <div id="fileInfo"></div>
    </div>
    
    <div id="results"></div>

    <script src="/lib/signalr/dist/browser/signalr.min.js"></script>
    <script>
        let connection = null;
        const results = document.getElementById('results');
        
        function log(message, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.innerHTML = new Date().toLocaleTimeString() + ': ' + message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        async function testHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                log('âœ… å¥åº·æ£€æŸ¥æˆåŠŸ: ' + JSON.stringify(data));
            } catch (error) {
                log('âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ' + error.message, true);
            }
        }
        
        async function testRecent() {
            try {
                const response = await fetch('/api/conversion/recent');
                const data = await response.json();
                log('âœ… æœ€è¿‘ä»»åŠ¡APIæˆåŠŸ: ' + JSON.stringify(data));
            } catch (error) {
                log('âŒ æœ€è¿‘ä»»åŠ¡APIå¤±è´¥: ' + error.message, true);
            }
        }
        
        async function testSignalR() {
            try {
                if (connection) {
                    await connection.stop();
                }
                
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/conversionHub")
                    .build();
                
                connection.onclose(function (error) {
                    log('SignalRè¿æ¥å…³é—­: ' + (error || 'æ­£å¸¸å…³é—­'));
                });
                
                await connection.start();
                log('âœ… SignalRè¿æ¥æˆåŠŸ');
            } catch (error) {
                log('âŒ SignalRè¿æ¥å¤±è´¥: ' + error.message, true);
            }
        }
        
        async function disconnectSignalR() {
            if (connection) {
                await connection.stop();
                log('SignalRè¿æ¥å·²æ–­å¼€');
            }
        }
        
        function testFileValidation() {
            const fileInput = document.getElementById('testFile');
            const fileInfo = document.getElementById('fileInfo');

            if (!fileInput.files[0]) {
                log('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', true);
                return;
            }

            const file = fileInput.files[0];
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            const fileExt = file.name.split('.').pop().toLowerCase();

            fileInfo.innerHTML = `
                <strong>æ–‡ä»¶ä¿¡æ¯:</strong><br>
                åç§°: ${file.name}<br>
                å¤§å°: ${fileSize} MB<br>
                ç±»å‹: ${file.type}<br>
                æ‰©å±•å: .${fileExt}<br>
            `;

            log(`ğŸ“ æ–‡ä»¶ä¿¡æ¯: ${file.name} (${fileSize}MB, .${fileExt})`);

            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
            const supportedExts = ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm', '.m4v', '.3gp'];
            if (supportedExts.includes('.' + fileExt)) {
                log('âœ… æ–‡ä»¶æ ¼å¼æ”¯æŒ: .' + fileExt);
            } else {
                log('âŒ æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ: .' + fileExt, true);
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å° (2GBé™åˆ¶)
            if (file.size <= 2147483648) {
                log('âœ… æ–‡ä»¶å¤§å°ç¬¦åˆè¦æ±‚: ' + fileSize + 'MB');
            } else {
                log('âŒ æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶: ' + fileSize + 'MB (æœ€å¤§2048MB)', true);
            }
        }

        async function testUpload() {
            const fileInput = document.getElementById('testFile');
            if (!fileInput.files[0]) {
                log('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', true);
                return;
            }

            const file = fileInput.files[0];

            try {
                const formData = new FormData();
                formData.append('VideoFile', file);
                formData.append('TaskName', 'Test Upload - ' + file.name);
                formData.append('Preset', 'Fast 1080p30');

                log('å¼€å§‹ä¸Šä¼ æ–‡ä»¶: ' + file.name + ' (' + (file.size / (1024 * 1024)).toFixed(2) + 'MB)');

                const response = await fetch('/api/conversion/start', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    log('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ' + JSON.stringify(result));
                } else {
                    log('âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ (' + response.status + '): ' + JSON.stringify(result), true);
                }
            } catch (error) {
                log('âŒ æ–‡ä»¶ä¸Šä¼ é”™è¯¯: ' + error.message, true);
                log('é”™è¯¯è¯¦æƒ…: ' + error.toString(), true);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•åŸºç¡€è¿æ¥
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            testHealth();
            setTimeout(testSignalR, 1000);
        };
    </script>
</body>
</html>
